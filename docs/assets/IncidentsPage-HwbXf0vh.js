import{j as e,t as se,X as xe,$ as me,p as ue,a6 as he,Z as te}from"./ui-Donqwxo7.js";import{r as c}from"./vendor-CW-_dNtU.js";import{b as ne,u as pe,c as le}from"./query-Cw8NcARV.js";import{C as ge,h as ie,d as z,u as je}from"./index-CmI2uZiO.js";import{B as D}from"./badge-eiixo76M.js";import{B as x}from"./button-gHr9dfwR.js";import{I as P}from"./input-BvEpzQI5.js";import{S as B,a as $,b as H,c as Q,d as r}from"./switch-BrUN3v4I.js";import{a as be,u as ve,b as fe,s as Ne,C as ye,N as ae,S as C,n as we}from"./use-admin-BLZNP0tc.js";import{z as o,u as Se,C as Y,t as Ce}from"./index-DBEqNSC_.js";import{L as y}from"./label-D7Eeu5EM.js";import{T as Ie}from"./textarea-Bujwefd-.js";import"./utils-BTGVH9Kg.js";const V={1:{label:"Low",className:"bg-primary/10 text-primary border-primary/20"},2:{label:"Medium",className:"bg-amber-500/10 text-amber-600 border-amber-500/20"},3:{label:"High",className:"bg-orange-500/10 text-orange-600 border-orange-500/20"},4:{label:"Critical",className:"bg-red-500/10 text-red-600 border-red-500/20"}},O={open:{label:"Open",className:"bg-red-500/10 text-red-600 border-red-500/20"},investigating:{label:"Investigating",className:"bg-amber-500/10 text-amber-600 border-amber-500/20"},closed:{label:"Closed",className:"bg-primary/10 text-primary border-primary/20"}},re=[{key:"date",label:"Date"},{key:"type",label:"Type"},{key:"location",label:"Location"},{key:"severity",label:"Severity"},{key:"status",label:"Status"},{key:"investigator",label:"Investigator"}],I=10;function ke({onNew:k}){const b=ne(),w=be(),a=ve(),{data:i=[],isLoading:m}=pe({queryKey:["/api/incidents"]}),[p,L]=c.useState(""),[K,u]=c.useState(!1),[Z,R]=c.useState(null),[t,n]=c.useState("all"),[l,E]=c.useState("all"),[g,de]=c.useState({field:"",dir:null}),[F,oe]=c.useState(!1),[f,A]=c.useState(1),[U,ce]=fe(re),X=le({mutationFn:s=>ie("DELETE",`/api/incidents/${s}`),onSuccess:()=>b.invalidateQueries({queryKey:["/api/incidents"]})}),N=c.useMemo(()=>i.filter(s=>{var h,v,j,T,ee;if(t!=="all"&&s.status!==t||l!=="all"&&String(s.severity)!==l)return!1;if(p.trim()){const M=p.toLowerCase();return((h=s.type)==null?void 0:h.toLowerCase().includes(M))||((v=s.location)==null?void 0:v.toLowerCase().includes(M))||((j=s.description)==null?void 0:j.toLowerCase().includes(M))||((T=s.assignedInvestigator)==null?void 0:T.toLowerCase().includes(M))||((ee=s.date)==null?void 0:ee.toLowerCase().includes(M))}return!0}),[i,p,t,l]),q=c.useMemo(()=>Ne(N,g.field,g.dir),[N,g]),S=s=>de(h=>we(h.field,h.dir,s)),_=Math.ceil(q.length/I),J=F?q:q.slice((f-1)*I,f*I),W=s=>{L(s),A(1)},d=s=>U[s]!==!1;return e.jsxs(ge,{className:"overflow-hidden",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-4 p-5 border-b border-border",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl font-bold",children:"Incidents"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Incident tracker · ",i.length," record",i.length!==1?"s":""]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[K?e.jsxs("div",{className:"relative",children:[e.jsx(se,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(P,{placeholder:"Search incidents...",value:p,onChange:s=>W(s.target.value),className:"pl-9 w-[220px]",autoFocus:!0}),e.jsx("button",{type:"button",onClick:()=>{u(!1),W("")},className:"absolute right-2 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-foreground",children:e.jsx(xe,{className:"h-4 w-4"})})]}):e.jsx(x,{variant:"outline",size:"icon",onClick:()=>u(!0),children:e.jsx(se,{className:"h-4 w-4"})}),w&&e.jsx(ye,{columns:re,visible:U,onChange:ce}),e.jsxs(x,{onClick:k,className:"gap-2",children:[e.jsx(me,{className:"h-4 w-4"})," Report Incident"]})]})]}),e.jsxs("div",{className:"flex items-center gap-3 px-5 py-3 border-b border-border bg-muted/30",children:[e.jsxs(B,{value:t,onValueChange:n,children:[e.jsx($,{className:"w-[140px] h-8 text-xs",children:e.jsx(H,{placeholder:"Status"})}),e.jsxs(Q,{children:[e.jsx(r,{value:"all",children:"All Statuses"}),e.jsx(r,{value:"open",children:"Open"}),e.jsx(r,{value:"investigating",children:"Investigating"}),e.jsx(r,{value:"closed",children:"Closed"})]})]}),e.jsxs(B,{value:l,onValueChange:E,children:[e.jsx($,{className:"w-[140px] h-8 text-xs",children:e.jsx(H,{placeholder:"Severity"})}),e.jsxs(Q,{children:[e.jsx(r,{value:"all",children:"All Severities"}),e.jsx(r,{value:"1",children:"1 — Low"}),e.jsx(r,{value:"2",children:"2 — Medium"}),e.jsx(r,{value:"3",children:"3 — High"}),e.jsx(r,{value:"4",children:"4 — Critical"})]})]}),(t!=="all"||l!=="all")&&e.jsx(x,{variant:"ghost",size:"sm",className:"h-8 text-xs",onClick:()=>{n("all"),E("all")},children:"Clear filters"})]}),m?e.jsxs("div",{className:"p-8 text-center",children:[e.jsx("div",{className:"h-8 w-8 mx-auto mb-3 rounded-full border-2 border-primary border-t-transparent animate-spin"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Loading incidents..."})]}):N.length===0?e.jsxs("div",{className:"p-12 text-center",children:[e.jsx("div",{className:"w-12 h-12 mx-auto mb-4 rounded-full bg-muted flex items-center justify-center",children:e.jsx(ue,{className:"h-6 w-6 text-muted-foreground"})}),e.jsx("p",{className:"font-medium",children:p||t!=="all"||l!=="all"?"No matching incidents":"No incidents found"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:p?"Try adjusting your search or filters":"No incidents have been reported"})]}):e.jsxs(e.Fragment,{children:[a&&e.jsx("div",{className:"divide-y divide-border",children:J.map(s=>{var T;const h=V[s.severity]||V[1],v=O[s.status]||O.open,j=Z===s.id;return e.jsxs("div",{className:"px-4 py-3",children:[e.jsxs("button",{type:"button",className:"flex items-center justify-between w-full text-left",onClick:()=>R(j?null:s.id),children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium capitalize",children:(T=s.type)==null?void 0:T.replace("-"," ")}),e.jsx("p",{className:"text-xs text-muted-foreground",children:s.location})]}),e.jsx(he,{className:`h-4 w-4 text-muted-foreground transition-transform ${j?"rotate-180":""}`})]}),j&&e.jsxs("div",{className:"mt-3 space-y-2 pl-1",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx("span",{className:"text-muted-foreground w-24",children:"Date"}),e.jsx("span",{children:s.date})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx("span",{className:"text-muted-foreground w-24",children:"Severity"}),e.jsx(D,{variant:"outline",className:h.className,children:h.label})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx("span",{className:"text-muted-foreground w-24",children:"Status"}),e.jsx(D,{variant:"outline",className:v.className,children:v.label})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx("span",{className:"text-muted-foreground w-24",children:"Investigator"}),e.jsx(ae,{name:s.assignedInvestigator})]}),e.jsx("div",{className:"pt-1",children:e.jsx(x,{variant:"ghost",size:"icon",className:"h-7 w-7 text-muted-foreground hover:text-destructive",onClick:()=>X.mutate(s.id),children:e.jsx(te,{className:"h-3.5 w-3.5"})})})]})]},s.id)})}),!a&&e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-border bg-muted/50",children:[d("date")&&e.jsx(C,{label:"Date",field:"date",current:g,onSort:S}),d("type")&&e.jsx(C,{label:"Type",field:"type",current:g,onSort:S}),d("location")&&e.jsx(C,{label:"Location",field:"location",current:g,onSort:S}),d("severity")&&e.jsx(C,{label:"Severity",field:"severity",current:g,onSort:S}),d("status")&&e.jsx(C,{label:"Status",field:"status",current:g,onSort:S}),d("investigator")&&e.jsx(C,{label:"Investigator",field:"assignedInvestigator",current:g,onSort:S}),e.jsx("th",{className:"py-3 px-5"})]})}),e.jsx("tbody",{children:J.map(s=>{var j;const h=V[s.severity]||V[1],v=O[s.status]||O.open;return e.jsxs("tr",{className:"border-b border-border last:border-0 hover:bg-primary/5 transition-colors",children:[d("date")&&e.jsx("td",{className:"py-3.5 px-5 text-sm text-muted-foreground",children:s.date}),d("type")&&e.jsx("td",{className:"py-3.5 px-5 text-sm font-medium capitalize",children:(j=s.type)==null?void 0:j.replace("-"," ")}),d("location")&&e.jsx("td",{className:"py-3.5 px-5 text-sm",children:s.location}),d("severity")&&e.jsx("td",{className:"py-3.5 px-5",children:e.jsx(D,{variant:"outline",className:h.className,children:h.label})}),d("status")&&e.jsx("td",{className:"py-3.5 px-5",children:e.jsx(D,{variant:"outline",className:v.className,children:v.label})}),d("investigator")&&e.jsx("td",{className:"py-3.5 px-5",children:e.jsx(ae,{name:s.assignedInvestigator})}),e.jsx("td",{className:"py-3.5 px-5",children:e.jsx(x,{variant:"ghost",size:"icon",className:"h-7 w-7 text-muted-foreground hover:text-destructive",onClick:()=>X.mutate(s.id),children:e.jsx(te,{className:"h-3.5 w-3.5"})})})]},s.id)})})]})})]}),!m&&N.length>0&&e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-2 px-5 py-3 border-t border-border bg-muted/30 text-xs text-muted-foreground",children:[e.jsxs("span",{children:["Showing ",F?N.length:`${(f-1)*I+1}–${Math.min(f*I,q.length)}`," of ",N.length," incident",N.length!==1?"s":"",p&&` matching "${p}"`]}),e.jsxs("div",{className:"flex items-center gap-2",children:[!F&&_>1&&e.jsxs(e.Fragment,{children:[e.jsx(x,{variant:"outline",size:"sm",className:"h-7 text-xs px-2",disabled:f<=1,onClick:()=>A(s=>s-1),children:"Prev"}),e.jsxs("span",{className:"text-xs tabular-nums",children:[f," / ",_]}),e.jsx(x,{variant:"outline",size:"sm",className:"h-7 text-xs px-2",disabled:f>=_,onClick:()=>A(s=>s+1),children:"Next"})]}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-7 text-xs",onClick:()=>{oe(!F),A(1)},children:F?`Show ${I} per page`:"Show all"})]})]})]})}const Le=o.object({date:o.string().min(1,"Required"),type:o.enum(["near-miss","injury","property-damage","environmental"]),location:o.string().min(1,"Required"),description:o.string().min(1,"Required"),severity:o.union([o.literal(1),o.literal(2),o.literal(3),o.literal(4)]),assignedInvestigator:o.string().min(1,"Required"),status:o.enum(["open","investigating","closed"])}),Ee=["","Low","Medium","High","Critical"],Fe=["","bg-green-100 text-green-700 border-green-200","bg-yellow-100 text-yellow-700 border-yellow-200","bg-orange-100 text-orange-700 border-orange-200","bg-red-100 text-red-700 border-red-200"],G=[{n:1,label:"Incident Details"},{n:2,label:"Triage"},{n:3,label:"Investigation"},{n:4,label:"Sign Off"}];function Te({onSubmit:k,onCancel:b,isLoading:w}){var R;const[a,i]=c.useState(1),{register:m,handleSubmit:p,control:L,trigger:K,formState:{errors:u}}=Se({resolver:Ce(Le),defaultValues:{date:"",type:"near-miss",location:"",description:"",severity:1,assignedInvestigator:"",status:"open"}}),Z=async()=>{await K(["date","type","location","description"])&&i(l=>Math.min(l+1,4))};return e.jsxs("div",{className:"flex flex-col md:flex-row h-full md:min-h-[480px] border border-border rounded-lg overflow-hidden bg-card",children:[e.jsxs("div",{className:"flex md:hidden items-center gap-1 px-4 py-3 border-b border-border bg-muted overflow-x-auto",children:[G.map(t=>{const n=t.n===a,l=t.n<a,E=t.n<=a;return e.jsxs("button",{type:"button",onClick:()=>E&&i(t.n),disabled:!E,className:z("flex items-center gap-1.5 px-2.5 py-1.5 rounded-full text-xs font-medium whitespace-nowrap transition-colors",n?"bg-primary text-primary-foreground":l?"bg-emerald-500/10 text-emerald-600":"text-muted-foreground/40"),children:[e.jsx("span",{className:z("h-5 w-5 rounded-full flex items-center justify-center text-[10px] font-bold shrink-0",l&&"bg-emerald-500 text-white",n&&"bg-primary-foreground text-primary",!l&&!n&&"border-2 border-muted-foreground/20 text-muted-foreground/30"),children:l?"✓":t.n}),n&&e.jsx("span",{children:t.label})]},t.n)}),e.jsx("button",{type:"button",onClick:b,className:"ml-auto text-xs text-muted-foreground/50 hover:text-destructive whitespace-nowrap px-2",children:"× Exit"})]}),e.jsxs("div",{className:"hidden md:flex w-48 shrink-0 border-r border-border bg-muted/20 flex-col p-4",children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("p",{className:"text-xs font-semibold text-muted-foreground uppercase tracking-wider",children:"New Incident"}),e.jsx("span",{className:"mt-1 inline-block text-xs font-semibold px-2 py-0.5 rounded-full bg-blue-100 text-blue-700",children:"Draft"})]}),e.jsx("div",{className:"space-y-1",children:G.map(t=>e.jsxs("button",{type:"button",onClick:()=>t.n<=a&&i(t.n),className:z("w-full flex items-center gap-3 px-2 py-2 rounded-md text-sm transition-colors text-left",t.n===a?"bg-background text-foreground font-medium shadow-sm":t.n<a?"text-muted-foreground hover:text-foreground hover:bg-background/60 cursor-pointer":"text-muted-foreground/40 cursor-default"),children:[e.jsx("span",{className:z("h-6 w-6 rounded-full border-2 flex items-center justify-center text-xs font-bold shrink-0",t.n===a?"border-primary bg-primary text-primary-foreground":t.n<a?"border-green-500 bg-green-500 text-white":"border-border text-muted-foreground"),children:t.n<a?"✓":t.n}),e.jsx("span",{children:t.label})]},t.n))})]}),e.jsxs("form",{onSubmit:p(k),className:"flex-1 flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between px-4 sm:px-6 py-3 border-b border-border",children:[e.jsx("h2",{className:"text-base font-semibold",children:(R=G.find(t=>t.n===a))==null?void 0:R.label}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(x,{type:"button",variant:"ghost",size:"sm",onClick:b,className:"hidden sm:inline-flex",children:"Cancel"}),a<4?e.jsx(x,{type:"button",size:"sm",onClick:Z,children:"Next →"}):e.jsx(x,{type:"submit",size:"sm",disabled:w,children:w?"Saving...":"Submit Report"})]})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 sm:p-6",children:[a===1&&e.jsx("div",{className:"space-y-4 max-w-xl",children:e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(y,{children:"Date"}),e.jsx(P,{type:"date",...m("date")}),u.date&&e.jsx("p",{className:"text-xs text-destructive",children:u.date.message})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(y,{children:"Type"}),e.jsx(Y,{name:"type",control:L,render:({field:t})=>e.jsxs(B,{value:t.value,onValueChange:t.onChange,children:[e.jsx($,{children:e.jsx(H,{})}),e.jsxs(Q,{children:[e.jsx(r,{value:"near-miss",children:"Near Miss"}),e.jsx(r,{value:"injury",children:"Injury"}),e.jsx(r,{value:"property-damage",children:"Property Damage"}),e.jsx(r,{value:"environmental",children:"Environmental"})]})]})})]}),e.jsxs("div",{className:"sm:col-span-2 space-y-1",children:[e.jsx(y,{children:"Location"}),e.jsx(P,{...m("location"),placeholder:"e.g. Bay 4 – Forklift Zone"}),u.location&&e.jsx("p",{className:"text-xs text-destructive",children:u.location.message})]}),e.jsxs("div",{className:"sm:col-span-2 space-y-1",children:[e.jsx(y,{children:"Description"}),e.jsx(Ie,{...m("description"),placeholder:"Describe what happened, when, and who was involved...",rows:4}),u.description&&e.jsx("p",{className:"text-xs text-destructive",children:u.description.message})]})]})}),a===2&&e.jsxs("div",{className:"space-y-5 max-w-xl",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Assess the initial severity of this incident."}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{children:"Severity Rating"}),e.jsx(Y,{name:"severity",control:L,render:({field:t})=>e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-3",children:[1,2,3,4].map(n=>e.jsxs("button",{type:"button",onClick:()=>t.onChange(n),className:z("py-4 rounded-lg text-center border-2 transition-all",t.value===n?Fe[n]:"border-border text-muted-foreground hover:bg-muted"),children:[e.jsx("p",{className:"text-2xl font-bold",children:n}),e.jsx("p",{className:"text-xs mt-1",children:Ee[n]})]},n))})})]})]}),a===3&&e.jsxs("div",{className:"space-y-4 max-w-xl",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Assign an investigator to follow up on this incident."}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(y,{children:"Assigned Investigator"}),e.jsx(P,{...m("assignedInvestigator"),placeholder:"Full name"}),u.assignedInvestigator&&e.jsx("p",{className:"text-xs text-destructive",children:u.assignedInvestigator.message})]})]}),a===4&&e.jsxs("div",{className:"space-y-4 max-w-xl",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Set the initial status and submit the incident report."}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(y,{children:"Status"}),e.jsx(Y,{name:"status",control:L,render:({field:t})=>e.jsxs(B,{value:t.value,onValueChange:t.onChange,children:[e.jsx($,{children:e.jsx(H,{})}),e.jsxs(Q,{children:[e.jsx(r,{value:"open",children:"Open"}),e.jsx(r,{value:"investigating",children:"Investigating"}),e.jsx(r,{value:"closed",children:"Closed"})]})]})})]})]})]}),a>1&&e.jsx("div",{className:"px-4 sm:px-6 pb-4",children:e.jsx(x,{type:"button",variant:"ghost",size:"sm",onClick:()=>i(t=>t-1),children:"← Back"})})]})]})}function Ke(){const[k,b]=c.useState(!1),w=ne(),{toast:a}=je(),i=le({mutationFn:m=>ie("POST","/api/incidents",m),onSuccess:()=>{w.invalidateQueries({queryKey:["/api/incidents"]}),b(!1),a({title:"Incident reported."})}});return e.jsx("div",{className:"p-4 sm:p-6",children:k?e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:"Report Incident"}),e.jsx(Te,{onSubmit:m=>i.mutate(m),onCancel:()=>b(!1),isLoading:i.isPending})]}):e.jsx(ke,{onNew:()=>b(!0)})})}export{Ke as default};
