import{j as e,t as K,X as de,$ as ce,F as $,a6 as me,Z as Y,a4 as se,a8 as xe,z as ue}from"./ui-Donqwxo7.js";import{r as b}from"./vendor-CW-_dNtU.js";import{b as te,u as he,c as re}from"./query-Cw8NcARV.js";import{C as pe,d as v,h as ae,u as be}from"./index-CmI2uZiO.js";import{B}from"./badge-eiixo76M.js";import{B as n}from"./button-gHr9dfwR.js";import{I as q}from"./input-BvEpzQI5.js";import{a as je,u as ge,b as fe,s as ye,C as Ne,N as L,S as C,n as ve}from"./use-admin-BLZNP0tc.js";import{z as i,u as we,C as O,t as ke}from"./index-DBEqNSC_.js";import{L as N}from"./label-D7Eeu5EM.js";import{T as Se}from"./textarea-Bujwefd-.js";import{S as X,a as Z,b as G,c as J,d as F}from"./switch-BrUN3v4I.js";import"./utils-BTGVH9Kg.js";const H={approved:"bg-primary/10 text-primary border-primary/20",pending:"bg-amber-500/10 text-amber-600 border-amber-500/20",draft:"bg-muted text-muted-foreground border-border"},Ce={"Hot Work":"bg-red-500/10 text-red-600",Electrical:"bg-amber-500/10 text-amber-600","Confined Space":"bg-purple-500/10 text-purple-600","Working at Height":"bg-blue-500/10 text-blue-600","Cold Work":"bg-sky-500/10 text-sky-600",Mechanical:"bg-orange-500/10 text-orange-600"},ee=[{key:"date",label:"Date"},{key:"workType",label:"Work Type"},{key:"location",label:"Location"},{key:"submitter",label:"Submitter"},{key:"manager",label:"Manager"},{key:"status",label:"Status"}],T=10;function Te({onNew:P}){const j=te(),g=je(),x=ge(),{data:a=[],isLoading:l}=he({queryKey:["/api/permits"]}),[u,k]=b.useState(""),[h,d]=b.useState({field:"",dir:null}),[f,D]=b.useState(!1),[p,t]=b.useState(1),[c,o]=fe(ee),[ne,I]=b.useState(!1),[ie,le]=b.useState(null),U=re({mutationFn:s=>ae("DELETE",`/api/permits/${s}`),onSuccess:()=>j.invalidateQueries({queryKey:["/api/permits"]})}),w=b.useMemo(()=>{if(!u.trim())return a;const s=u.toLowerCase();return a.filter(r=>{var y,A,W,E,Q,_;return((y=r.submitter)==null?void 0:y.toLowerCase().includes(s))||((A=r.manager)==null?void 0:A.toLowerCase().includes(s))||((W=r.location)==null?void 0:W.toLowerCase().includes(s))||((E=r.workType)==null?void 0:E.toLowerCase().includes(s))||((Q=r.date)==null?void 0:Q.toLowerCase().includes(s))||((_=r.status)==null?void 0:_.toLowerCase().includes(s))})},[a,u]),M=b.useMemo(()=>ye(w,h.field,h.dir),[w,h]),S=s=>d(r=>ve(r.field,r.dir,s)),z=Math.ceil(M.length/T),R=f?M:M.slice((p-1)*T,p*T),oe=s=>{k(s),t(1)},m=s=>c[s]!==!1;return e.jsxs(pe,{className:"overflow-hidden",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-4 p-5 border-b border-border",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl font-bold",children:"Permit to Work"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Manage and issue work permits · ",a.length," record",a.length!==1?"s":""]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[ne?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"relative",children:[e.jsx(K,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(q,{autoFocus:!0,placeholder:"Search permits...",value:u,onChange:s=>oe(s.target.value),onBlur:()=>{setTimeout(()=>{u.trim()||I(!1)},200)},className:"pl-9 w-[220px]"})]}),e.jsx(n,{variant:"ghost",size:"icon",className:"h-9 w-9",onClick:()=>{k(""),I(!1),t(1)},children:e.jsx(de,{className:"h-4 w-4"})})]}):e.jsx(n,{variant:"outline",size:"icon",className:"h-9 w-9",onClick:()=>I(!0),children:e.jsx(K,{className:"h-4 w-4"})}),g&&e.jsx(Ne,{columns:ee,visible:c,onChange:o}),e.jsxs(n,{onClick:P,className:"gap-2",children:[e.jsx(ce,{className:"h-4 w-4"})," New Permit"]})]})]}),l?e.jsxs("div",{className:"p-8 text-center",children:[e.jsx("div",{className:"h-8 w-8 mx-auto mb-3 rounded-full border-2 border-primary border-t-transparent animate-spin"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Loading permits..."})]}):w.length===0?e.jsxs("div",{className:"p-12 text-center",children:[e.jsx("div",{className:"w-12 h-12 mx-auto mb-4 rounded-full bg-muted flex items-center justify-center",children:e.jsx($,{className:"h-6 w-6 text-muted-foreground"})}),e.jsx("p",{className:"font-medium",children:u?"No matching permits":"No permits yet"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:u?"Try adjusting your search terms":"Create one to get started"})]}):e.jsxs(e.Fragment,{children:[x&&R.length>0&&e.jsx("div",{className:"divide-y divide-border",children:R.map(s=>{var y,A,W,E;const r=ie===s.id;return e.jsxs("div",{className:"bg-background",children:[e.jsxs("button",{type:"button",className:"w-full flex items-center justify-between gap-3 p-4 text-left hover:bg-primary/5 transition-colors",onClick:()=>le(r?null:s.id),children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium truncate",children:s.workType||"—"}),e.jsx("p",{className:"text-xs text-muted-foreground truncate",children:s.location||"—"})]}),e.jsxs("div",{className:"flex items-center gap-2 shrink-0",children:[e.jsx(B,{variant:"outline",className:H[s.status]??"bg-muted",children:s.status==="approved"?"Issued":((y=s.status)==null?void 0:y.charAt(0).toUpperCase())+((A=s.status)==null?void 0:A.slice(1))}),e.jsx(me,{className:`h-4 w-4 text-muted-foreground transition-transform ${r?"rotate-180":""}`})]})]}),r&&e.jsxs("div",{className:"px-4 pb-4 space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Date"}),e.jsx("span",{children:s.date||"—"})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-muted-foreground",children:"Submitter"}),e.jsx(L,{name:s.submitter})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-muted-foreground",children:"Manager"}),e.jsx(L,{name:s.manager})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-muted-foreground",children:"Status"}),e.jsx(B,{variant:"outline",className:H[s.status]??"bg-muted",children:s.status==="approved"?"Issued":((W=s.status)==null?void 0:W.charAt(0).toUpperCase())+((E=s.status)==null?void 0:E.slice(1))})]}),e.jsx("div",{className:"flex justify-end pt-2 border-t border-border",children:e.jsx(n,{variant:"ghost",size:"icon",className:"h-7 w-7 text-muted-foreground hover:text-destructive",onClick:()=>U.mutate(s.id),children:e.jsx(Y,{className:"h-3.5 w-3.5"})})})]})]},s.id)})}),!x&&e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-border bg-muted/50",children:[m("date")&&e.jsx(C,{label:"Date",field:"date",current:h,onSort:S}),m("workType")&&e.jsx(C,{label:"Work Type",field:"workType",current:h,onSort:S}),m("location")&&e.jsx(C,{label:"Location",field:"location",current:h,onSort:S}),m("submitter")&&e.jsx(C,{label:"Submitter",field:"submitter",current:h,onSort:S}),m("manager")&&e.jsx(C,{label:"Manager",field:"manager",current:h,onSort:S}),m("status")&&e.jsx(C,{label:"Status",field:"status",current:h,onSort:S}),e.jsx("th",{className:"py-3 px-5"})]})}),e.jsx("tbody",{children:R.map(s=>{var r,y;return e.jsxs("tr",{className:"border-b border-border last:border-0 hover:bg-primary/5 transition-colors",children:[m("date")&&e.jsx("td",{className:"py-3.5 px-5 text-sm text-muted-foreground",children:s.date}),m("workType")&&e.jsx("td",{className:"py-3.5 px-5",children:e.jsx("span",{className:v("text-xs font-medium px-2 py-0.5 rounded-full",Ce[s.workType]??"bg-muted text-muted-foreground"),children:s.workType||"—"})}),m("location")&&e.jsx("td",{className:"py-3.5 px-5 text-sm truncate max-w-[160px]",children:s.location||"—"}),m("submitter")&&e.jsx("td",{className:"py-3.5 px-5",children:e.jsx(L,{name:s.submitter})}),m("manager")&&e.jsx("td",{className:"py-3.5 px-5",children:e.jsx(L,{name:s.manager})}),m("status")&&e.jsx("td",{className:"py-3.5 px-5",children:e.jsx(B,{variant:"outline",className:H[s.status]??"bg-muted",children:s.status==="approved"?"Issued":((r=s.status)==null?void 0:r.charAt(0).toUpperCase())+((y=s.status)==null?void 0:y.slice(1))})}),e.jsx("td",{className:"py-3.5 px-5",children:e.jsx(n,{variant:"ghost",size:"icon",className:"h-7 w-7 text-muted-foreground hover:text-destructive",onClick:()=>U.mutate(s.id),children:e.jsx(Y,{className:"h-3.5 w-3.5"})})})]},s.id)})})]})})]}),!l&&w.length>0&&e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-2 px-5 py-3 border-t border-border bg-muted/30 text-xs text-muted-foreground",children:[e.jsxs("span",{children:["Showing ",f?w.length:`${(p-1)*T+1}–${Math.min(p*T,M.length)}`," of ",w.length," permit",w.length!==1?"s":"",u&&` matching "${u}"`]}),e.jsxs("div",{className:"flex items-center gap-2",children:[!f&&z>1&&e.jsxs(e.Fragment,{children:[e.jsx(n,{variant:"outline",size:"sm",className:"h-7 text-xs px-2",disabled:p<=1,onClick:()=>t(s=>s-1),children:"Prev"}),e.jsxs("span",{className:"text-xs tabular-nums",children:[p," / ",z]}),e.jsx(n,{variant:"outline",size:"sm",className:"h-7 text-xs px-2",disabled:p>=z,onClick:()=>t(s=>s+1),children:"Next"})]}),e.jsx(n,{variant:"ghost",size:"sm",className:"h-7 text-xs",onClick:()=>{D(!f),t(1)},children:f?`Show ${T} per page`:"Show all"})]})]})]})}const qe=i.object({date:i.string().min(1,"Required"),submitter:i.string().min(1,"Required"),manager:i.string().min(1,"Required"),location:i.string().min(1,"Required"),workType:i.enum(["Hot Work","Cold Work","Electrical","Working at Height","Confined Space","Mechanical"]),workDescription:i.string().min(1,"Required"),spq1:i.enum(["yes","no"]),spq2:i.enum(["yes","no"]),spq3:i.enum(["yes","no"]),spq4:i.enum(["yes","no"]),spq5:i.enum(["yes","no"]),authorityName:i.string(),status:i.enum(["draft","pending","approved"])}),Pe=[{key:"spq1",text:"Where necessary, appropriate fire alarm zones / sprinkler systems have been isolated?"},{key:"spq2",text:"Fire and emergency procedures have been communicated to all personnel on site?"},{key:"spq3",text:"Appropriate fire fighting equipment is in place and accessible?"},{key:"spq4",text:"Method for raising the alarm has been agreed and communicated?"},{key:"spq5",text:"Where possible, combustible / flammable materials have been removed from the area of work?"}],V=[{id:"details",label:"Permit Details",icon:$},{id:"precautions",label:"Safety Precautions",icon:ue},{id:"authority",label:"Authority to Proceed",icon:se}];function Ae({onSubmit:P,onCancel:j,isLoading:g}){var p;const[x,a]=b.useState("details"),{register:l,handleSubmit:u,control:k,watch:h,formState:{errors:d}}=we({resolver:ke(qe),defaultValues:{date:"",submitter:"",manager:"",location:"",workType:"Cold Work",workDescription:"",spq1:"no",spq2:"no",spq3:"no",spq4:"no",spq5:"no",authorityName:"",status:"draft"}}),f=h("status"),D={draft:"bg-muted text-muted-foreground",pending:"bg-amber-100 text-amber-800",approved:"bg-green-100 text-green-800"};return e.jsxs("div",{className:"flex flex-col md:flex-row h-full md:min-h-[540px] border border-border rounded-lg overflow-hidden bg-card",children:[e.jsxs("div",{className:"flex md:hidden items-center gap-1 px-4 py-3 border-b border-border bg-muted overflow-x-auto",children:[V.map((t,c)=>{const o=x===t.id;return e.jsxs("button",{type:"button",onClick:()=>a(t.id),className:v("flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-medium whitespace-nowrap transition-colors",o?"bg-primary text-primary-foreground":"text-muted-foreground hover:bg-muted"),children:[e.jsx("span",{className:v("h-5 w-5 rounded-full flex items-center justify-center text-[10px] font-bold shrink-0",o?"bg-primary-foreground text-primary":"border-2 border-muted-foreground/20 text-muted-foreground/40"),children:c+1}),o&&e.jsx("span",{children:t.label})]},t.id)}),e.jsx("button",{type:"button",onClick:j,className:"ml-auto text-xs text-muted-foreground/50 hover:text-destructive whitespace-nowrap px-2",children:"× Exit"})]}),e.jsxs("div",{className:"hidden md:flex w-56 shrink-0 bg-slate-800 text-white flex-col",children:[e.jsxs("div",{className:"p-4 border-b border-slate-700",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx($,{className:"h-4 w-4 text-slate-400"}),e.jsx("span",{className:"font-semibold text-sm",children:"Permit to Work"})]}),e.jsx("span",{className:v("text-xs font-semibold px-2 py-1 rounded-full uppercase tracking-wide",D[f]),children:f})]}),e.jsxs("nav",{className:"flex-1 p-3 space-y-1",children:[e.jsx("p",{className:"text-[10px] font-semibold uppercase tracking-widest text-slate-500 px-2 mb-2",children:"Tabs"}),V.map((t,c)=>{t.icon;const o=x===t.id;return e.jsxs("button",{type:"button",onClick:()=>a(t.id),className:v("w-full flex items-center gap-3 px-3 py-2 rounded-md text-sm transition-colors text-left",o?"bg-slate-700 text-white":"text-slate-400 hover:bg-slate-700/50 hover:text-white"),children:[e.jsx("span",{className:v("h-5 w-5 rounded-full border-2 flex items-center justify-center text-[10px] font-bold shrink-0",o?"border-green-400 bg-green-400 text-slate-900":"border-slate-600 text-slate-500"),children:c+1}),e.jsx("span",{children:t.label})]},t.id)})]}),e.jsx("div",{className:"p-3 border-t border-slate-700",children:e.jsx("button",{type:"button",onClick:j,className:"w-full text-xs text-slate-500 hover:text-slate-300 text-left px-2 py-1 transition-colors",children:"✕ Exit Record"})})]}),e.jsxs("form",{onSubmit:u(P),className:"flex-1 flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between px-4 sm:px-6 py-3 border-b border-border bg-muted/30",children:[e.jsx("h2",{className:"text-base font-semibold",children:(p=V.find(t=>t.id===x))==null?void 0:p.label}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(n,{type:"button",variant:"outline",size:"sm",onClick:j,className:"hidden sm:inline-flex",children:"Exit Record"}),e.jsx(n,{type:"submit",size:"sm",disabled:g,children:g?"Saving...":"Save"})]})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 sm:p-6",children:[x==="details"&&e.jsxs("div",{className:"space-y-5 max-w-2xl",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(N,{children:"Date"}),e.jsx(q,{type:"date",...l("date")}),d.date&&e.jsx("p",{className:"text-xs text-destructive",children:d.date.message})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(N,{children:"Work Type"}),e.jsx(O,{name:"workType",control:k,render:({field:t})=>e.jsxs(X,{value:t.value,onValueChange:t.onChange,children:[e.jsx(Z,{children:e.jsx(G,{})}),e.jsx(J,{children:["Hot Work","Cold Work","Electrical","Working at Height","Confined Space","Mechanical"].map(c=>e.jsx(F,{value:c,children:c},c))})]})})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(N,{children:"Submitter"}),e.jsx(q,{...l("submitter"),placeholder:"Full name"}),d.submitter&&e.jsx("p",{className:"text-xs text-destructive",children:d.submitter.message})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(N,{children:"Manager"}),e.jsx(q,{...l("manager"),placeholder:"Full name"}),d.manager&&e.jsx("p",{className:"text-xs text-destructive",children:d.manager.message})]}),e.jsxs("div",{className:"sm:col-span-2 space-y-1",children:[e.jsx(N,{children:"Location"}),e.jsx(q,{...l("location"),placeholder:"e.g. Building 3 – Fab Bay 7"}),d.location&&e.jsx("p",{className:"text-xs text-destructive",children:d.location.message})]}),e.jsxs("div",{className:"sm:col-span-2 space-y-1",children:[e.jsx(N,{children:"Description of Work"}),e.jsx(Se,{...l("workDescription"),placeholder:"Describe the work to be carried out...",rows:3}),d.workDescription&&e.jsx("p",{className:"text-xs text-destructive",children:d.workDescription.message})]})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(n,{type:"button",onClick:()=>a("precautions"),children:"Next: Safety Precautions →"})})]}),x==="precautions"&&e.jsxs("div",{className:"space-y-5 max-w-2xl",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Confirm each safety precaution has been addressed before proceeding."}),e.jsx("div",{className:"divide-y divide-border border border-border rounded-lg overflow-hidden",children:Pe.map(({key:t,text:c})=>e.jsx(O,{name:t,control:k,render:({field:o})=>e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-2 px-4 py-4 bg-card hover:bg-muted/30 transition-colors",children:[e.jsx("p",{className:"text-sm pr-4",children:c}),e.jsxs("div",{className:"flex gap-2 shrink-0",children:[e.jsxs("button",{type:"button",onClick:()=>o.onChange("yes"),className:v("flex items-center gap-1.5 px-3 py-1.5 rounded-md text-xs font-medium border transition-colors",o.value==="yes"?"bg-green-100 border-green-300 text-green-800":"border-border text-muted-foreground hover:bg-muted"),children:[e.jsx(se,{className:"h-3.5 w-3.5"})," Yes"]}),e.jsxs("button",{type:"button",onClick:()=>o.onChange("no"),className:v("flex items-center gap-1.5 px-3 py-1.5 rounded-md text-xs font-medium border transition-colors",o.value==="no"?"bg-red-50 border-red-300 text-red-700":"border-border text-muted-foreground hover:bg-muted"),children:[e.jsx(xe,{className:"h-3.5 w-3.5"})," No"]})]})]})},t))}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx(n,{type:"button",variant:"outline",onClick:()=>a("details"),children:"← Back"}),e.jsx(n,{type:"button",onClick:()=>a("authority"),children:"Next: Authority to Proceed →"})]})]}),x==="authority"&&e.jsxs("div",{className:"space-y-5 max-w-2xl",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Complete authority sign-off before issuing this permit."}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(N,{children:"Authorised By"}),e.jsx(q,{...l("authorityName"),placeholder:"Name of person authorising"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(N,{children:"Permit Status"}),e.jsx(O,{name:"status",control:k,render:({field:t})=>e.jsxs(X,{value:t.value,onValueChange:t.onChange,children:[e.jsx(Z,{children:e.jsx(G,{})}),e.jsxs(J,{children:[e.jsx(F,{value:"draft",children:"Draft"}),e.jsx(F,{value:"pending",children:"Pending Approval"}),e.jsx(F,{value:"approved",children:"Approved / Issued"})]})]})})]})]}),e.jsxs("div",{className:"flex justify-between pt-2",children:[e.jsx(n,{type:"button",variant:"outline",onClick:()=>a("precautions"),children:"← Back"}),e.jsx(n,{type:"submit",disabled:g,className:"min-w-[120px]",children:g?"Saving...":"Issue Permit"})]})]})]})]})]})}function $e(){const[P,j]=b.useState(!1),g=te(),{toast:x}=be(),a=re({mutationFn:l=>ae("POST","/api/permits",l),onSuccess:()=>{g.invalidateQueries({queryKey:["/api/permits"]}),j(!1),x({title:"Permit created."})}});return P?e.jsx("div",{className:"p-4 sm:p-6 h-full max-w-5xl",children:e.jsx(Ae,{onSubmit:l=>a.mutate(l),onCancel:()=>j(!1),isLoading:a.isPending})}):e.jsx("div",{className:"p-4 sm:p-6",children:e.jsx(Te,{onNew:()=>j(!0)})})}export{$e as default};
