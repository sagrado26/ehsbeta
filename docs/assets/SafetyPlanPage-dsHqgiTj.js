import{j as e,y as me,X as te,z as Te,D as ue,E as Ke,O as Pe,G as Re,I as Qe,J as Le,K as ze,N as Ue,Q as Ge,p as U,W as ee,Y as B,F as T,S as se,Z as xe,_ as Xe,$ as Ee,a0 as Ye,a1 as _e,a2 as Ze,a3 as Oe,a4 as Je,a5 as Me,t as je,a6 as es,a7 as ss,a8 as ts,a9 as rs,aa as as,ab as is}from"./ui-Donqwxo7.js";import{r as g}from"./vendor-CW-_dNtU.js";import{b as He,u as V,c as Ie}from"./query-Cw8NcARV.js";import{d as b,T as Ae,e as Ne,f as ye,g as ve,C as z,h as De,u as ns}from"./index-CmI2uZiO.js";import{I as M}from"./input-BvEpzQI5.js";import{L as E}from"./label-D7Eeu5EM.js";import{B as N}from"./button-gHr9dfwR.js";import{S as re,a as ae,b as ie,c as ne,d as $}from"./switch-BrUN3v4I.js";import{z as K,u as ls,t as ds}from"./index-DBEqNSC_.js";import{u as We,N as _,a as cs,b as os,s as ms,C as xs,S as D,n as us}from"./use-admin-BLZNP0tc.js";import{T as ps}from"./textarea-Bujwefd-.js";import{B as F}from"./badge-eiixo76M.js";import"./utils-BTGVH9Kg.js";const ke=[{n:1,label:"Task Details"},{n:2,label:"Safety Questions"},{n:3,label:"Hazard ID"},{n:4,label:"Sign Off"}];function hs({currentStep:r,completedSteps:c,onStepClick:n,prefilled:l,taskSummary:d,onEditDetails:x,onExit:u}){return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"md:hidden flex items-center gap-1 px-2 py-2.5 border-b border-border bg-muted/30 overflow-x-auto",children:[ke.map((m,t)=>{const s=c.includes(m.n),i=r===m.n,p=s||i;return e.jsxs("div",{className:"flex items-center gap-1 shrink-0",children:[t>0&&e.jsx("div",{className:b("w-3 h-px",s?"bg-primary":"bg-border")}),e.jsxs("button",{type:"button",disabled:!p,onClick:()=>p&&n(m.n),className:b("flex items-center gap-1 rounded-full text-[11px] font-medium transition-colors whitespace-nowrap",i?"px-2.5 py-1.5":"px-1.5 py-1.5",i?"bg-primary text-primary-foreground shadow-sm":s?"bg-primary/10 text-primary hover:bg-primary/20 cursor-pointer":"bg-muted text-muted-foreground/40 cursor-default"),children:[e.jsx("span",{className:b("h-5 w-5 rounded-full flex items-center justify-center text-[10px] font-bold shrink-0",i&&"bg-primary-foreground text-primary",s&&!i&&"bg-primary text-primary-foreground",!s&&!i&&"border border-muted-foreground/20 text-muted-foreground/30"),children:s&&!i?e.jsx(me,{className:"h-3 w-3",strokeWidth:3}):m.n}),i&&e.jsx("span",{children:m.label})]})]},m.n)}),e.jsx("div",{className:"flex-1"}),u&&e.jsx("button",{type:"button",onClick:u,className:"text-muted-foreground/40 hover:text-destructive transition-colors shrink-0 p-1.5",children:e.jsx(te,{className:"h-3.5 w-3.5"})})]}),e.jsxs("div",{className:"hidden md:flex w-56 shrink-0 flex-col bg-muted border-r border-border",children:[e.jsxs("div",{className:"p-4 border-b border-border",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("div",{className:"p-1 rounded bg-primary/10",children:e.jsx(Te,{className:"h-3.5 w-3.5 text-primary"})}),e.jsx("span",{className:"font-semibold text-sm text-foreground",children:"New ISP"})]}),l&&e.jsxs("div",{className:"flex flex-wrap gap-1",children:[e.jsx("span",{className:"px-1.5 py-0.5 rounded bg-primary/8 text-primary text-[10px] font-medium",children:l.system}),e.jsx("span",{className:"px-1.5 py-0.5 rounded bg-primary/8 text-primary text-[10px] font-medium",children:l.group}),e.jsx("span",{className:"px-1.5 py-0.5 rounded bg-muted text-muted-foreground text-[10px] font-medium",children:l.date})]})]}),e.jsxs("nav",{className:"flex-1 p-3 space-y-1",children:[e.jsx("p",{className:"text-[10px] font-semibold uppercase tracking-widest text-muted-foreground/50 px-2 mb-2",children:"Steps"}),ke.map(m=>{const t=c.includes(m.n),s=r===m.n,i=t||s;return e.jsxs("button",{type:"button",disabled:!i,onClick:()=>i&&n(m.n),className:b("w-full flex items-center gap-3 px-3 py-2 rounded-md text-sm transition-colors text-left",s?"bg-primary text-primary-foreground font-medium shadow-sm":i?"text-muted-foreground hover:bg-muted hover:text-foreground":"text-muted-foreground/40 cursor-default"),children:[e.jsx("span",{className:b("h-5 w-5 rounded-full flex items-center justify-center text-[10px] font-bold shrink-0",t&&!s&&"bg-primary text-primary-foreground",s&&"bg-primary-foreground text-primary border-0",!t&&!s&&"border-2 border-muted-foreground/20 text-muted-foreground/30"),children:t&&!s?e.jsx(me,{className:"h-3 w-3",strokeWidth:3}):m.n}),e.jsx("span",{children:m.label})]},m.n)})]}),d&&c.includes(1)&&r>1&&e.jsxs("div",{className:"px-4 py-3 border-t border-border",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("p",{className:"text-[10px] font-semibold uppercase tracking-wider text-muted-foreground/50",children:"Task Info"}),x&&e.jsx("button",{type:"button",onClick:x,className:"text-muted-foreground/40 hover:text-foreground transition-colors",children:e.jsx(ue,{className:"h-3 w-3"})})]}),e.jsxs("div",{className:"space-y-0.5 text-[11px]",children:[e.jsx("p",{className:"text-foreground font-medium truncate",children:d.taskName}),e.jsxs("p",{className:"text-muted-foreground truncate",children:[d.shift," · ",d.location]}),e.jsxs("p",{className:"text-muted-foreground truncate",children:["Machine: ",d.machineNumber]})]})]}),u&&e.jsx("div",{className:"p-3 border-t border-border",children:e.jsx("button",{type:"button",onClick:u,className:"w-full text-xs text-muted-foreground/50 hover:text-destructive text-left px-2 py-1 transition-colors",children:"× Exit Record"})})]})]})}const gs=["SCN","SRC","DL","NA"],bs=K.object({taskName:K.string().min(1,"Task name is required"),location:K.string().min(1,"Location is required"),shift:K.string().min(1,"Shift is required"),machineNumber:K.string().min(1,"Machine number is required")});function ce({label:r,required:c,options:n,value:l,onChange:d,error:x,placeholder:u}){const[m,t]=g.useState(!1);return m?e.jsxs("div",{children:[e.jsxs(E,{className:"text-sm font-medium",children:[r," ",c&&e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsxs("div",{className:"flex gap-2 mt-1.5",children:[e.jsx(M,{value:l,onChange:s=>d(s.target.value),placeholder:u,autoFocus:!0}),e.jsx(N,{type:"button",variant:"outline",size:"sm",onClick:()=>t(!1),children:"List"})]}),x&&e.jsx("p",{className:"text-xs text-destructive mt-1",children:x})]}):e.jsxs("div",{children:[e.jsxs(E,{className:"text-sm font-medium",children:[r," ",c&&e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsxs(re,{value:l,onValueChange:s=>{s==="__other__"?(t(!0),d("")):d(s)},children:[e.jsx(ae,{className:"mt-1.5",children:e.jsx(ie,{placeholder:u||`Select ${r.toLowerCase()}`})}),e.jsxs(ne,{children:[n.map(s=>e.jsx($,{value:s,children:s},s)),e.jsx($,{value:"__other__",children:"+ Add new..."})]})]}),x&&e.jsx("p",{className:"text-xs text-destructive mt-1",children:x})]})}function fs({onSubmit:r,defaultValues:c,knownValues:n}){var w,P,v;const[l,d]=g.useState(""),{register:x,handleSubmit:u,formState:{errors:m},setValue:t,watch:s}=ls({resolver:ds(bs),defaultValues:{taskName:"",location:"",shift:"",machineNumber:""}}),i=s("location"),p=s("shift"),a=s("machineNumber"),C=s("taskName"),f=y=>{const O=l?`${l} - ${y.taskName}`:y.taskName;r({...y,taskName:O,group:c.group,system:c.system,region:c.region,date:c.date,canSocialDistance:c.canSocialDistance})};return e.jsxs("form",{onSubmit:u(f),className:"space-y-5",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-lg font-semibold text-foreground",children:"New ISP"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Fill in the task details to get started"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs(E,{className:"text-sm font-medium",children:["Task Name ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsxs("div",{className:"flex gap-2 mt-1.5",children:[e.jsxs(re,{value:l,onValueChange:d,children:[e.jsx(ae,{className:"w-[100px] shrink-0",children:e.jsx(ie,{placeholder:"Type"})}),e.jsx(ne,{children:gs.map(y=>e.jsx($,{value:y,children:y},y))})]}),e.jsxs("div",{className:"flex-1 relative",children:[l&&e.jsxs("span",{className:"absolute left-3 top-1/2 -translate-y-1/2 text-sm text-muted-foreground pointer-events-none",children:[l," - "]}),e.jsx(M,{...x("taskName"),placeholder:"e.g. Quarterly maintenance check",className:l?"pl-[70px]":""})]})]}),m.taskName&&e.jsx("p",{className:"text-xs text-destructive mt-1",children:m.taskName.message}),l&&C&&e.jsxs("p",{className:"text-xs text-muted-foreground mt-1.5",children:["Full name: ",e.jsxs("span",{className:"font-medium text-foreground",children:[l," - ",C]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4",children:[e.jsx(ce,{label:"Shift",required:!0,options:n.shifts,value:p,onChange:y=>t("shift",y,{shouldValidate:!0}),error:(w=m.shift)==null?void 0:w.message,placeholder:"Select shift"}),e.jsx(ce,{label:"Location",required:!0,options:n.locations,value:i,onChange:y=>t("location",y,{shouldValidate:!0}),error:(P=m.location)==null?void 0:P.message,placeholder:"Select location"}),e.jsx(ce,{label:"Machine No.",required:!0,options:n.machines,value:a,onChange:y=>t("machineNumber",y,{shouldValidate:!0}),error:(v=m.machineNumber)==null?void 0:v.message,placeholder:"Select machine"})]})]}),e.jsx("div",{className:"flex justify-end",children:e.jsxs(N,{type:"submit",className:"gap-2",children:["Next Step",e.jsx(Ke,{className:"h-4 w-4"})]})})]})}const oe=[{key:"q1_specializedTraining",label:"Specialized Training",hint:"Confined space, QEW, H2, Crane Operator certification"},{key:"q2_chemicals",label:"Chemicals / Hazardous Materials",hint:"Task involves chemicals or hazardous substances"},{key:"q3_impactOthers",label:"Other Work in Area",hint:"Other work that may impact this task"},{key:"q4_falls",label:"Fall Hazard",hint:"Falls of 4 feet (1.2m) or greater"},{key:"q5_barricades",label:"Barricades Required",hint:"Trip hazards, floor tile removal"},{key:"q6_loto",label:"LOTO Required",hint:"Lock Out Tag Out procedures"},{key:"q7_lifting",label:"Heavy Lifting",hint:"Items over 35lbs / 15.9kg"},{key:"q8_ergonomics",label:"Ergonomic Concerns",hint:"Abnormal ergonomic situations"},{key:"q10_headInjury",label:"Head Injury Risk",hint:"Hard hat requirements"},{key:"q11_otherPPE",label:"Additional PPE",hint:"Knee pads, cut resistant gloves"},{key:"q9_otherConcerns",label:"Other Safety Concerns",hint:"Additional concerns not listed"}];function js({values:r,onChange:c}){const n=oe.filter(d=>r[d.key]==="yes").length,l=We();return e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-md bg-primary/10",children:e.jsx(Te,{className:"w-5 h-5 text-primary"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"font-semibold",children:"Pretask Safety Check"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:n>0?`${n} concern${n!==1?"s":""} flagged`:"Tap each item to flag concerns"})]})]})}),l&&e.jsx("div",{className:"space-y-2",children:oe.map((d,x)=>{const u=r[d.key]==="yes";return e.jsx("button",{type:"button",onClick:()=>c(d.key,u?"no":"yes"),className:b("w-full text-left rounded-lg border-2 p-4 transition-all",u?"border-primary bg-primary/5":"border-border bg-card"),children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:b("h-7 w-7 rounded-full flex items-center justify-center text-xs font-bold shrink-0 transition-colors",u?"bg-primary text-primary-foreground":"bg-muted text-muted-foreground"),children:u?e.jsx(me,{className:"h-3.5 w-3.5"}):x+1}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium",children:d.label}),e.jsx("p",{className:"text-xs text-muted-foreground mt-0.5",children:d.hint})]})]})},d.key)})}),!l&&e.jsx(Ae,{delayDuration:200,children:e.jsx("div",{className:"rounded-lg border border-border overflow-hidden",children:oe.map((d,x)=>{const u=r[d.key];return e.jsxs("div",{className:"flex items-center gap-3 px-4 py-2.5 hover:bg-muted/30 transition-colors",children:[e.jsx("span",{className:"text-[11px] font-semibold text-muted-foreground/50 w-5 shrink-0 text-right tabular-nums",children:x+1}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-[13px] font-medium text-foreground truncate",children:d.label}),e.jsx("p",{className:"text-[11px] text-muted-foreground/60 mt-0.5",children:d.hint})]}),e.jsxs("div",{className:"flex gap-1 shrink-0",children:[e.jsx("button",{type:"button",onClick:()=>c(d.key,"yes"),className:b("h-7 w-12 rounded text-[11px] font-semibold transition-all",u==="yes"?"bg-primary text-primary-foreground shadow-sm":"bg-muted text-muted-foreground hover:bg-muted/80"),children:"Yes"}),e.jsx("button",{type:"button",onClick:()=>c(d.key,"no"),className:b("h-7 w-12 rounded text-[11px] font-semibold transition-all",u==="no"?"bg-destructive text-destructive-foreground shadow-sm":"bg-muted text-muted-foreground hover:bg-muted/80"),children:"No"})]})]},d.key)})})})]})}const Fe=Ue,Ns=Ge,Ve=g.forwardRef(({className:r,...c},n)=>e.jsx(Pe,{ref:n,className:b("fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",r),...c}));Ve.displayName=Pe.displayName;const pe=g.forwardRef(({className:r,children:c,...n},l)=>e.jsxs(Ns,{children:[e.jsx(Ve,{}),e.jsxs(Re,{ref:l,className:b("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",r),...n,children:[c,e.jsxs(Qe,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground",children:[e.jsx(te,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Close"})]})]})]}));pe.displayName=Re.displayName;const he=({className:r,...c})=>e.jsx("div",{className:b("flex flex-col space-y-1.5 text-center sm:text-left",r),...c});he.displayName="DialogHeader";const ge=g.forwardRef(({className:r,...c},n)=>e.jsx(Le,{ref:n,className:b("text-lg font-semibold leading-none tracking-tight",r),...c}));ge.displayName=Le.displayName;const ys=g.forwardRef(({className:r,...c},n)=>e.jsx(ze,{ref:n,className:b("text-sm text-muted-foreground",r),...c}));ys.displayName=ze.displayName;const Be=[{name:"+35 lb Manual Lifts",checklistRequired:!1,checklistType:"",permitRequired:!1,permitType:"",training:"Manual Handling",example:"Manually lifting a 50 lb pump or motor"},{name:"Hoisting or Crane Use",checklistRequired:!0,checklistType:"Pre Hoist / Crane Checklist",permitRequired:!1,permitType:"",training:"2 or 4 Point Crane trained",example:"Using an overhead crane"},{name:"Mechanical Hazards",checklistRequired:!1,checklistType:"",permitRequired:!1,permitType:"",training:"",example:"Sharp edges, moving parts"},{name:"Falling Objects / Safety Netting",checklistRequired:!1,checklistType:"",permitRequired:!1,permitType:"",training:"COHE - PPE",example:"Overhead work"},{name:"Working at Height",checklistRequired:!0,checklistType:"Harness & MSLC Checklist",permitRequired:!1,permitType:"",training:"COHE / ASML WoW",example:"Elevated platform work"},{name:"Electrical Work (LOTO)",checklistRequired:!0,checklistType:"LOTO Checklist",permitRequired:!1,permitType:"",training:"COHE / ASML WoW",example:"Electrical panel servicing"},{name:"High or Low Temperature",checklistRequired:!1,checklistType:"",permitRequired:!1,permitType:"",training:"",example:"Hot piping, cryogenics"},{name:"Noise",checklistRequired:!1,checklistType:"",permitRequired:!1,permitType:"",training:"",example:"Loud equipment"},{name:"Floor Tie Lift / Barricades",checklistRequired:!1,checklistType:"",permitRequired:!1,permitType:"",training:"Floor Tile Lift / CoHE",example:"Floor openings"},{name:"Optical Radiation",checklistRequired:!1,checklistType:"",permitRequired:!1,permitType:"",training:"",example:"Laser, UV, IR exposure"},{name:"Material Movements",checklistRequired:!1,checklistType:"",permitRequired:!1,permitType:"",training:"Manual Handling",example:"Awkward/heavy materials"},{name:"Ionizing / EM Radiation",checklistRequired:!1,checklistType:"",permitRequired:!1,permitType:"",training:"",example:"RF or radiation areas"},{name:"Permanent Magnetic Fields",checklistRequired:!1,checklistType:"",permitRequired:!1,permitType:"",training:"Magnetic Training",example:"MRI or strong magnets"},{name:"Combustible / Flammable",checklistRequired:!1,checklistType:"",permitRequired:!0,permitType:"Permit to Work",training:"Vacuum System",example:"Hydrogen systems"},{name:"Toxic Materials",checklistRequired:!1,checklistType:"",permitRequired:!0,permitType:"Permit to Work",training:"Chemical Handling",example:"Tin dust, CO2, N2, IPA"},{name:"Confined Space",checklistRequired:!1,checklistType:"",permitRequired:!0,permitType:"Permit to Work",training:"Confined Space",example:"Tanks, pits"},{name:"Lack of Oxygen",checklistRequired:!1,checklistType:"",permitRequired:!0,permitType:"Permit to Work",training:"Hazardous chemicals",example:"CO2 or N2 displacement"},{name:"Fluids (Water, Gas, Vacuum)",checklistRequired:!1,checklistType:"",permitRequired:!1,permitType:"",training:"Hazardous chemicals",example:"Pressurized systems"},{name:"Ergonomic Risk",checklistRequired:!1,checklistType:"",permitRequired:!1,permitType:"",training:"Ergonomic Risk assessment",example:"Repetitive/awkward work"}];function G(r){return Be.find(c=>c.name===r)}const vs=["","Negligible","Minor","Major","Catastrophic"],ks=["","Unlikely","Possible","Likely","Almost Certain"];function ws(r){return r>=12?{bg:"bg-red-500",text:"text-white",label:"Extreme",ring:"ring-red-500/20"}:r>=8?{bg:"bg-orange-500",text:"text-white",label:"High",ring:"ring-orange-500/20"}:r>=4?{bg:"bg-amber-400",text:"text-amber-950",label:"Medium",ring:"ring-amber-400/20"}:{bg:"bg-emerald-500",text:"text-white",label:"Low",ring:"ring-emerald-500/20"}}function Ss({open:r,onOpenChange:c,hazardName:n,assessment:l,onSave:d,onRemove:x}){const[u,m]=g.useState(l.severity),[t,s]=g.useState(l.likelihood),[i,p]=g.useState(l.mitigation),a=G(n);g.useEffect(()=>{m(l.severity),s(l.likelihood),p(l.mitigation)},[l,r]);const C=u*t,f=ws(C),w=()=>{d({severity:u,likelihood:t,mitigation:i,requiresChecklist:(a==null?void 0:a.checklistRequired)??l.requiresChecklist,checklistType:(a==null?void 0:a.checklistType)??l.checklistType,requiresPtW:(a==null?void 0:a.permitRequired)??l.requiresPtW,permitType:(a==null?void 0:a.permitType)??l.permitType}),c(!1)},P=()=>{x(),c(!1)};return e.jsx(Fe,{open:r,onOpenChange:c,children:e.jsxs(pe,{className:"sm:max-w-[420px] p-0 gap-0 overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between px-5 pt-4 pb-3",children:[e.jsxs(he,{className:"flex-row items-center gap-2.5 space-y-0",children:[e.jsx(U,{className:"h-4 w-4 text-amber-500 shrink-0"}),e.jsx(ge,{className:"text-sm font-semibold",children:n})]}),e.jsxs("div",{className:b("flex items-center gap-1.5 px-2.5 py-1 rounded-full ring-2 text-xs font-bold",f.bg,f.text,f.ring),children:[C," ",e.jsx("span",{className:"font-medium text-[10px] opacity-80",children:f.label})]})]}),e.jsxs("div",{className:"px-5 pb-4 space-y-3",children:[a&&e.jsxs("div",{className:"text-[11px] text-muted-foreground bg-muted/50 rounded-md px-3 py-2 space-y-0.5",children:[e.jsxs("p",{children:["e.g. ",a.example]}),a.training&&e.jsxs("p",{className:"flex items-center gap-1",children:[e.jsx(ee,{className:"h-3 w-3"})," Training: ",a.training]})]}),((a==null?void 0:a.checklistRequired)||(a==null?void 0:a.permitRequired))&&e.jsxs("div",{className:"flex flex-wrap gap-2",children:[(a==null?void 0:a.checklistRequired)&&e.jsxs("span",{className:"inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md bg-blue-500/10 text-blue-600 text-[11px] font-medium border border-blue-500/20",children:[e.jsx(B,{className:"h-3.5 w-3.5"})," ",a.checklistType]}),(a==null?void 0:a.permitRequired)&&e.jsxs("span",{className:"inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md bg-amber-500/10 text-amber-600 text-[11px] font-medium border border-amber-500/20",children:[e.jsx(T,{className:"h-3.5 w-3.5"})," ",a.permitType]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-[10px] font-semibold uppercase tracking-wider text-muted-foreground mb-1.5",children:"Severity"}),e.jsx("div",{className:"grid grid-cols-4 gap-1",children:[1,2,3,4].map(v=>e.jsx("button",{type:"button",onClick:()=>m(v),className:b("h-8 rounded text-xs font-semibold transition-all",u===v?"bg-primary text-primary-foreground shadow-sm":"bg-muted hover:bg-muted/80 text-muted-foreground"),children:v},v))}),e.jsx("p",{className:"text-[10px] text-muted-foreground mt-1 text-center",children:vs[u]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-[10px] font-semibold uppercase tracking-wider text-muted-foreground mb-1.5",children:"Likelihood"}),e.jsx("div",{className:"grid grid-cols-4 gap-1",children:[1,2,3,4].map(v=>e.jsx("button",{type:"button",onClick:()=>s(v),className:b("h-8 rounded text-xs font-semibold transition-all",t===v?"bg-primary text-primary-foreground shadow-sm":"bg-muted hover:bg-muted/80 text-muted-foreground"),children:v},v))}),e.jsx("p",{className:"text-[10px] text-muted-foreground mt-1 text-center",children:ks[t]})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-1.5 mb-1.5",children:[e.jsx(se,{className:"h-3 w-3 text-primary"}),e.jsx("p",{className:"text-[10px] font-semibold uppercase tracking-wider text-muted-foreground",children:"Mitigation Plan"})]}),e.jsx(ps,{rows:2,value:i,onChange:v=>p(v.target.value),placeholder:"Describe the controls and mitigation measures...",className:"text-sm resize-none"}),!i.trim()&&e.jsx("p",{className:"text-[10px] text-destructive mt-1",children:"Mitigation plan is required before saving."})]}),e.jsxs("div",{className:"flex justify-between items-center pt-1",children:[e.jsxs(N,{type:"button",variant:"ghost",size:"sm",onClick:P,className:"gap-1 text-xs text-destructive hover:text-destructive hover:bg-destructive/10 h-8 px-2",children:[e.jsx(xe,{className:"h-3 w-3"})," Remove"]}),e.jsx(N,{type:"button",size:"sm",onClick:w,disabled:!i.trim(),className:"h-8 px-4 text-xs",children:"Save Assessment"})]})]})]})})}function Cs(r){return r>=12?{bg:"bg-red-500",text:"text-white",label:"Extreme"}:r>=8?{bg:"bg-orange-500",text:"text-white",label:"High"}:r>=4?{bg:"bg-amber-400",text:"text-amber-900",label:"Medium"}:{bg:"bg-emerald-500",text:"text-white",label:"Low"}}function qs({hazards:r,assessments:c,onHazardsChange:n}){const[l,d]=g.useState(null),x=t=>{if(!t||r.includes(t))return;const s=G(t),i=[...r,t],p={...c,[t]:{severity:1,likelihood:1,mitigation:"",requiresChecklist:(s==null?void 0:s.checklistRequired)??!1,checklistType:(s==null?void 0:s.checklistType)??"",requiresPtW:(s==null?void 0:s.permitRequired)??!1,permitType:(s==null?void 0:s.permitType)??""}};n(i,p),d(t)},u=t=>{const s={...c};delete s[t],n(r.filter(i=>i!==t),s)},m=(t,s)=>{n(r,{...c,[t]:s})};return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-md bg-primary/10",children:e.jsx(U,{className:"w-5 h-5 text-primary"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"font-semibold",children:"Hazard Identification"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:r.length>0?`${r.length} hazard${r.length!==1?"s":""} identified`:"Select hazards from the list below"})]})]}),e.jsxs(re,{value:"",onValueChange:x,children:[e.jsx(ae,{className:"w-full",children:e.jsx(ie,{placeholder:"Select a hazard..."})}),e.jsx(ne,{children:Be.filter(t=>!r.includes(t.name)).map(t=>e.jsx($,{value:t.name,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:t.name}),t.checklistRequired&&e.jsx("span",{className:"text-[9px] font-medium px-1.5 py-0.5 rounded bg-blue-500/10 text-blue-600",children:"Checklist"}),t.permitRequired&&e.jsx("span",{className:"text-[9px] font-medium px-1.5 py-0.5 rounded bg-amber-500/10 text-amber-600",children:"PtW"})]})},t.name))})]}),r.length===0&&e.jsxs("div",{className:"rounded-lg border-2 border-dashed border-border py-10 text-center",children:[e.jsx(U,{className:"h-6 w-6 text-muted-foreground/30 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"No hazards identified yet."}),e.jsx("p",{className:"text-[11px] text-muted-foreground/60 mt-1",children:"Select a hazard from the dropdown to begin."})]}),r.length>0&&e.jsx(Ae,{delayDuration:200,children:e.jsx("div",{className:"rounded-lg border border-border overflow-hidden",children:r.map(t=>{const s=c[t]||{severity:1,likelihood:1,mitigation:"",requiresChecklist:!1,checklistType:"",requiresPtW:!1,permitType:""},i=s.severity*s.likelihood,p=Cs(i),a=G(t);return e.jsxs("button",{type:"button",onClick:()=>d(t),className:"w-full flex items-start gap-3 px-4 py-3 text-left hover:bg-muted/40 transition-colors border-b border-border last:border-0",children:[e.jsxs("div",{className:"flex flex-col items-center shrink-0 mt-0.5 w-12",children:[e.jsx("span",{className:b("flex h-7 w-7 items-center justify-center rounded-md text-[11px] font-bold",p.bg,p.text),children:i}),e.jsx("span",{className:b("text-[9px] font-semibold uppercase mt-1",i>=8?"text-red-600":i>=4?"text-amber-600":"text-emerald-600"),children:p.label})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-[13px] font-medium text-foreground",children:t}),(a==null?void 0:a.example)&&e.jsxs("p",{className:"text-[11px] text-muted-foreground/60 italic",children:["e.g. ",a.example]}),(s.requiresChecklist||s.requiresPtW||(a==null?void 0:a.training))&&e.jsxs("div",{className:"flex flex-wrap gap-1.5 mt-1.5",children:[s.requiresChecklist&&e.jsxs("span",{className:"inline-flex items-center gap-1 px-1.5 py-0.5 rounded bg-blue-500/10 text-blue-600 text-[10px] font-medium",children:[e.jsx(B,{className:"h-3 w-3"})," ",s.checklistType||"Checklist Required",(a==null?void 0:a.training)&&e.jsxs(Ne,{children:[e.jsx(ye,{asChild:!0,children:e.jsx(ee,{className:"h-3 w-3 ml-0.5 cursor-help"})}),e.jsxs(ve,{side:"top",className:"text-xs max-w-[200px]",children:["Training: ",a.training]})]})]}),!s.requiresChecklist&&(a==null?void 0:a.training)&&e.jsxs(Ne,{children:[e.jsx(ye,{asChild:!0,children:e.jsxs("span",{className:"inline-flex items-center gap-1 text-[10px] text-muted-foreground/60 cursor-help",children:[e.jsx(ee,{className:"h-3 w-3"})," ",a.training]})}),e.jsx(ve,{side:"top",className:"text-xs",children:"Training required"})]}),s.requiresPtW&&e.jsxs("span",{className:"inline-flex items-center gap-1 px-1.5 py-0.5 rounded bg-amber-500/10 text-amber-600 text-[10px] font-medium",children:[e.jsx(T,{className:"h-3 w-3"})," ",s.permitType||"PtW Required"]})]}),s.mitigation&&e.jsxs("div",{className:"mt-1.5",children:[e.jsx("p",{className:"text-[10px] font-semibold uppercase tracking-wider text-emerald-600",children:"Mitigation"}),e.jsx("p",{className:"text-[11px] text-muted-foreground",children:s.mitigation})]}),!s.mitigation&&e.jsx("p",{className:"text-[11px] text-muted-foreground/50 mt-1 italic",children:"Tap to assess this hazard"})]}),e.jsx("div",{className:"shrink-0 mt-1",children:e.jsx(ue,{className:"h-3.5 w-3.5 text-muted-foreground/40"})})]},t)})})}),l&&e.jsx(Ss,{open:!!l,onOpenChange:t=>{t||d(null)},hazardName:l,assessment:c[l]||{severity:1,likelihood:1,mitigation:"",requiresChecklist:!1,checklistType:"",requiresPtW:!1,permitType:""},onSave:t=>m(l,t),onRemove:()=>u(l)})]})}function Ts({leadName:r,approverName:c,engineers:n,comments:l,linkedPermitId:d,permits:x=[],onChange:u}){const[m,t]=g.useState(""),s=()=>{m.trim()&&(u("engineers",[...n,m.trim()]),t(""))},i=x.filter(a=>a.status==="approved"||a.status==="pending"),p=x.find(a=>a.id===d);return e.jsxs("div",{className:"space-y-5",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-md bg-primary/10",children:e.jsx(Xe,{className:"w-5 h-5 text-primary"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"font-semibold",children:"Sign Off"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Names and final comment"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs(E,{className:"text-sm font-medium",children:["Lead Name ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(M,{value:r,onChange:a=>u("leadName",a.target.value),placeholder:"Lead assessor name",className:"mt-1.5"})]}),e.jsxs("div",{children:[e.jsx(E,{className:"text-sm font-medium",children:"Manager Name"}),e.jsx(M,{value:c,onChange:a=>u("approverName",a.target.value),placeholder:"Approving manager",className:"mt-1.5"})]})]}),e.jsxs("div",{children:[e.jsx(E,{className:"text-sm font-medium",children:"Team Members"}),e.jsxs("div",{className:"flex gap-2 mt-1.5",children:[e.jsx(M,{value:m,onChange:a=>t(a.target.value),onKeyDown:a=>a.key==="Enter"&&(a.preventDefault(),s()),placeholder:"Add name and press Enter"}),e.jsx(N,{type:"button",variant:"outline",size:"icon",onClick:s,className:"shrink-0",children:e.jsx(Ee,{className:"h-4 w-4"})})]}),n.length>0&&e.jsx("div",{className:"flex flex-wrap gap-1.5 mt-2",children:n.map(a=>e.jsxs("span",{className:"inline-flex items-center gap-1 px-2.5 py-1 rounded-md bg-muted text-sm text-foreground/80",children:[a,e.jsx("button",{type:"button",onClick:()=>u("engineers",n.filter(C=>C!==a)),className:"text-muted-foreground hover:text-destructive transition-colors",children:e.jsx(te,{className:"h-3 w-3"})})]},a))})]}),e.jsxs("div",{children:[e.jsx(E,{className:"text-sm font-medium",children:"Comment"}),e.jsx(M,{value:l,onChange:a=>u("comments",a.target.value),placeholder:"Any additional notes...",className:"mt-1.5"})]}),i.length>0&&e.jsxs("div",{className:"pt-3 border-t border-border",children:[e.jsx(E,{className:"text-xs text-muted-foreground font-medium",children:e.jsxs("span",{className:"flex items-center gap-1.5",children:[e.jsx(T,{className:"h-3 w-3"}),"Link Permit to Work (optional)"]})}),e.jsxs(re,{value:d?String(d):"none",onValueChange:a=>u("linkedPermitId",a==="none"?void 0:Number(a)),children:[e.jsx(ae,{className:"mt-1.5 h-9 text-sm",children:e.jsx(ie,{placeholder:"No linked permit"})}),e.jsxs(ne,{children:[e.jsx($,{value:"none",children:"No linked permit"}),i.map(a=>e.jsxs($,{value:String(a.id),children:["PTW-",String(a.id).padStart(4,"0")," — ",a.workType," (",a.location,")"]},a.id))]})]}),p&&e.jsxs("p",{className:"text-[11px] text-muted-foreground mt-1.5",children:[p.location," · ",p.date," · ",p.submitter]})]})]})}const we={q1_specializedTraining:"Specialized Training",q2_chemicals:"Chemicals / Hazardous Materials",q3_impactOthers:"Other Work in Area",q4_falls:"Fall Hazard",q5_barricades:"Barricades Required",q6_loto:"LOTO Required",q7_lifting:"Heavy Lifting",q8_ergonomics:"Ergonomic Concerns",q9_otherConcerns:"Other Safety Concerns",q10_headInjury:"Head Injury Risk",q11_otherPPE:"Additional PPE"};function Ps(r){return r>=12?{bg:"bg-red-500",text:"text-white",border:"border-red-500/30"}:r>=8?{bg:"bg-orange-500",text:"text-white",border:"border-orange-500/30"}:r>=4?{bg:"bg-amber-400",text:"text-amber-900",border:"border-amber-400/30"}:{bg:"bg-primary",text:"text-primary-foreground",border:"border-primary/20"}}function Rs(r){return r>=12?"Extreme":r>=8?"High":r>=4?"Medium":"Low"}function Ls({open:r,onOpenChange:c,data:n}){const l=Object.entries(we).filter(([s])=>n[s]==="yes").map(([,s])=>s),d=Object.keys(we).length-l.length,x=n.hazards.filter(s=>{var i;return(i=n.assessments[s])==null?void 0:i.requiresChecklist}),u=n.hazards.filter(s=>{var i;return(i=n.assessments[s])==null?void 0:i.requiresPtW}),m=x.length>0,t=u.length>0;return e.jsx(Fe,{open:r,onOpenChange:c,children:e.jsxs(pe,{className:"sm:max-w-lg max-h-[85vh] overflow-y-auto p-0",children:[e.jsxs("div",{className:"px-5 pt-5 pb-4 border-b border-border",children:[e.jsx(he,{className:"space-y-1",children:e.jsx(ge,{className:"text-lg font-bold",children:n.taskName||"Untitled Plan"})}),e.jsxs("div",{className:"flex flex-wrap items-center gap-x-4 gap-y-1.5 mt-3 text-xs text-muted-foreground",children:[e.jsxs("span",{className:"inline-flex items-center gap-1.5",children:[e.jsx(Ye,{className:"h-3.5 w-3.5"})," ",n.date]}),e.jsxs("span",{className:"inline-flex items-center gap-1.5",children:[e.jsx(_e,{className:"h-3.5 w-3.5"})," ",n.shift||"—"]}),e.jsxs("span",{className:"inline-flex items-center gap-1.5",children:[e.jsx(Ze,{className:"h-3.5 w-3.5"})," ",n.location||"—"]}),n.machineNumber&&e.jsxs("span",{children:["Machine: ",n.machineNumber]})]}),e.jsxs("div",{className:"flex gap-1.5 mt-2",children:[e.jsx("span",{className:"px-2 py-0.5 rounded-full bg-primary/10 text-primary text-[10px] font-medium",children:n.system}),e.jsx("span",{className:"px-2 py-0.5 rounded-full bg-primary/10 text-primary text-[10px] font-medium",children:n.group})]})]}),e.jsxs("div",{className:"px-5 pb-5 space-y-5",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2.5",children:[l.length>0?e.jsx(Oe,{className:"h-4 w-4 text-amber-600"}):e.jsx(se,{className:"h-4 w-4 text-primary"}),e.jsx("p",{className:"text-xs font-semibold uppercase tracking-wider text-muted-foreground",children:"Safety Checks"})]}),l.length>0?e.jsxs("div",{className:"rounded-lg bg-amber-50 dark:bg-amber-500/10 border border-amber-200 dark:border-amber-500/20 p-3.5",children:[e.jsxs("p",{className:"text-xs font-semibold text-amber-800 dark:text-amber-400 mb-2",children:[l.length," concern",l.length!==1?"s":""," flagged"]}),e.jsx("div",{className:"flex flex-wrap gap-1.5",children:l.map(s=>e.jsx("span",{className:"px-2 py-0.5 rounded-md bg-amber-100 dark:bg-amber-500/20 text-amber-800 dark:text-amber-300 text-[10px] font-medium",children:s},s))}),d>0&&e.jsxs("p",{className:"text-[10px] text-amber-700/60 dark:text-amber-400/60 mt-2",children:[d," items cleared"]})]}):e.jsxs("div",{className:"rounded-lg bg-primary/5 border border-primary/15 p-3.5 flex items-center gap-2.5",children:[e.jsx(Je,{className:"h-4 w-4 text-primary"}),e.jsx("p",{className:"text-xs font-medium text-primary",children:"All safety checks cleared"})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2.5",children:[e.jsx(U,{className:"h-4 w-4 text-primary"}),e.jsxs("p",{className:"text-xs font-semibold uppercase tracking-wider text-muted-foreground",children:["Hazards (",n.hazards.length,")"]})]}),n.hazards.length>0?e.jsx("div",{className:"space-y-2.5",children:n.hazards.map(s=>{const i=n.assessments[s],p=i?i.severity*i.likelihood:0,a=Ps(p);return G(s),e.jsx("div",{className:b("rounded-lg border-l-[3px] border border-border bg-card p-3.5 shadow-sm",a.border,"border-l-current"),style:{borderLeftColor:"hsl(var(--primary))"},children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("span",{className:b("h-8 min-w-[32px] px-1.5 flex items-center justify-center rounded-md text-xs font-bold shrink-0 mt-0.5",a.bg,a.text),children:p}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("p",{className:"text-sm font-semibold",children:s}),e.jsx("span",{className:b("text-[10px] font-semibold uppercase px-2 py-0.5 rounded-full shrink-0",a.bg,a.text),children:Rs(p)})]}),((i==null?void 0:i.requiresChecklist)||(i==null?void 0:i.requiresPtW))&&e.jsxs("div",{className:"flex flex-wrap gap-1.5 mt-1.5",children:[(i==null?void 0:i.requiresChecklist)&&e.jsxs("span",{className:"inline-flex items-center gap-1 px-1.5 py-0.5 rounded bg-blue-500/10 text-blue-600 text-[9px] font-medium",children:[e.jsx(B,{className:"h-2.5 w-2.5"})," ",i.checklistType]}),(i==null?void 0:i.requiresPtW)&&e.jsxs("span",{className:"inline-flex items-center gap-1 px-1.5 py-0.5 rounded bg-amber-500/10 text-amber-600 text-[9px] font-medium",children:[e.jsx(T,{className:"h-2.5 w-2.5"})," ",i.permitType]})]}),(i==null?void 0:i.mitigation)&&e.jsxs("p",{className:"text-[11px] text-muted-foreground mt-2 leading-relaxed",children:[e.jsx("span",{className:"font-medium text-foreground/70",children:"Mitigation:"})," ",i.mitigation]})]})]})},s)})}):e.jsx("p",{className:"text-xs text-muted-foreground italic",children:"No hazards identified"})]}),(m||t)&&e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-semibold uppercase tracking-wider text-muted-foreground mb-2.5",children:"Required Documents"}),e.jsxs("div",{className:"space-y-2",children:[m&&e.jsxs("div",{className:"flex items-center gap-2.5 rounded-lg border border-blue-200 dark:border-blue-500/20 bg-blue-50/50 dark:bg-blue-500/5 px-3.5 py-2.5",children:[e.jsx(B,{className:"h-4 w-4 text-blue-600 shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-semibold text-blue-800 dark:text-blue-400",children:"Link to Checklist"}),e.jsx("p",{className:"text-[10px] text-blue-700/70 dark:text-blue-400/60",children:x.map(s=>{var i;return(i=n.assessments[s])==null?void 0:i.checklistType}).filter(Boolean).join(", ")})]})]}),t&&e.jsxs("div",{className:"flex items-center gap-2.5 rounded-lg border border-amber-200 dark:border-amber-500/20 bg-amber-50/50 dark:bg-amber-500/5 px-3.5 py-2.5",children:[e.jsx(T,{className:"h-4 w-4 text-amber-600 shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-semibold text-amber-800 dark:text-amber-400",children:"Link to Permit to Work"}),e.jsxs("p",{className:"text-[10px] text-amber-700/70 dark:text-amber-400/60",children:["Required for: ",u.join(", ")]})]})]})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2.5",children:[e.jsx(Me,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("p",{className:"text-xs font-semibold uppercase tracking-wider text-muted-foreground",children:"Sign Off"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded-lg border border-border p-3",children:[e.jsx("p",{className:"text-[10px] text-muted-foreground mb-1",children:"Lead"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(_,{name:n.leadName}),e.jsx("p",{className:"text-sm font-medium",children:n.leadName||"—"})]})]}),e.jsxs("div",{className:"rounded-lg border border-border p-3",children:[e.jsx("p",{className:"text-[10px] text-muted-foreground mb-1",children:"Manager"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(_,{name:n.approverName||""}),e.jsx("p",{className:"text-sm font-medium",children:n.approverName||"—"})]})]})]}),n.engineers.length>0&&e.jsxs("div",{className:"flex items-center gap-2 mt-3",children:[e.jsx("div",{className:"flex -space-x-1.5",children:n.engineers.slice(0,4).map(s=>e.jsx(_,{name:s,className:"h-6 w-6 text-[9px] ring-2 ring-background"},s))}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[n.engineers.length," team member",n.engineers.length!==1?"s":""]})]}),n.comments&&e.jsxs("p",{className:"text-xs text-muted-foreground italic mt-2.5 pl-1 border-l-2 border-border",children:['"',n.comments,'"']})]})]})]})})}const J={approved:{icon:ss,label:"Approved",className:"bg-primary/10 text-primary border-primary/20"},pending:{icon:_e,label:"Pending",className:"bg-amber-500/10 text-amber-600 border-amber-500/20"},rejected:{icon:ts,label:"Rejected",className:"bg-red-500/10 text-red-600 border-red-500/20"},draft:{icon:T,label:"Draft",className:"bg-muted text-muted-foreground border-border"}},Se=[{key:"plan",label:"Plan"},{key:"task",label:"Task"},{key:"group",label:"Group"},{key:"date",label:"Date"},{key:"lead",label:"Lead"},{key:"version",label:"Version"},{key:"status",label:"Status"}],W=10;function zs({onNew:r,onEdit:c}){const n=He(),l=cs(),d=We(),{data:x=[],isLoading:u}=V({queryKey:["/api/safety-plans"]}),{data:m=[]}=V({queryKey:["/api/audit-logs"]}),[t,s]=g.useState(""),[i,p]=g.useState({field:"",dir:null}),[a,C]=g.useState(!1),[f,w]=g.useState(1),[P,v]=os(Se),[y,O]=g.useState(!1),[X,le]=g.useState(null),Y=Ie({mutationFn:o=>De("DELETE",`/api/safety-plans/${o}`),onSuccess:()=>n.invalidateQueries({queryKey:["/api/safety-plans"]})}),q=g.useMemo(()=>{if(!t.trim())return x;const o=t.toLowerCase();return x.filter(j=>{var I,A,L,Z,be,fe;return((I=j.taskName)==null?void 0:I.toLowerCase().includes(o))||((A=j.group)==null?void 0:A.toLowerCase().includes(o))||((L=j.leadName)==null?void 0:L.toLowerCase().includes(o))||((Z=j.location)==null?void 0:Z.toLowerCase().includes(o))||((be=j.machineNumber)==null?void 0:be.toLowerCase().includes(o))||((fe=j.status)==null?void 0:fe.toLowerCase().includes(o))||String(j.id).includes(o)})},[x,t]),H=g.useMemo(()=>ms(q,i.field,i.dir),[q,i]),h=g.useMemo(()=>{const o={};return m.forEach(j=>{j.action==="edited"&&(o[j.safetyPlanId]=(o[j.safetyPlanId]||1)+1)}),o},[m]),k=o=>p(j=>us(j.field,j.dir,o)),R=Math.ceil(H.length/W),de=a?H:H.slice((f-1)*W,f*W),$e=o=>{s(o),w(1)},S=o=>P[o]!==!1;return e.jsxs(z,{className:"overflow-hidden",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-4 p-5 border-b border-border",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl font-bold",children:"Safety Plans"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Pre-Task Plans (PTP) · ",x.length," record",x.length!==1?"s":""]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[y?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"relative",children:[e.jsx(je,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(M,{autoFocus:!0,placeholder:"Search plans...",value:t,onChange:o=>$e(o.target.value),onBlur:()=>{setTimeout(()=>{t.trim()||O(!1)},200)},className:"pl-9 w-[220px]"})]}),e.jsx(N,{variant:"ghost",size:"icon",className:"h-9 w-9",onClick:()=>{s(""),O(!1),w(1)},children:e.jsx(te,{className:"h-4 w-4"})})]}):e.jsx(N,{variant:"outline",size:"icon",className:"h-9 w-9",onClick:()=>O(!0),children:e.jsx(je,{className:"h-4 w-4"})}),l&&e.jsx(xs,{columns:Se,visible:P,onChange:v}),e.jsxs(N,{onClick:r,className:"gap-2",children:[e.jsx(Ee,{className:"h-4 w-4"})," New Plan"]})]})]}),u?e.jsxs("div",{className:"p-8 text-center",children:[e.jsx("div",{className:"h-8 w-8 mx-auto mb-3 rounded-full border-2 border-primary border-t-transparent animate-spin"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Loading safety plans..."})]}):q.length===0?e.jsxs("div",{className:"p-12 text-center",children:[e.jsx("div",{className:"w-12 h-12 mx-auto mb-4 rounded-full bg-muted flex items-center justify-center",children:e.jsx(T,{className:"h-6 w-6 text-muted-foreground"})}),e.jsx("p",{className:"font-medium",children:t?"No matching plans":"No safety plans yet"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:t?"Try adjusting your search terms":"Create one to get started"})]}):e.jsxs(e.Fragment,{children:[d&&de.length>0&&e.jsx("div",{className:"divide-y divide-border",children:de.map(o=>{const j=J[o.status]||J.draft,I=j.icon,A=h[o.id]||1,L=X===o.id;return e.jsxs("div",{className:"bg-background",children:[e.jsxs("button",{type:"button",className:"w-full flex items-center justify-between gap-3 p-4 text-left hover:bg-primary/5 transition-colors",onClick:()=>le(L?null:o.id),children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium truncate",children:o.taskName}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["ISP-",String(o.id).padStart(4,"0")]})]}),e.jsxs("div",{className:"flex items-center gap-2 shrink-0",children:[e.jsxs(F,{variant:"outline",className:`gap-1 ${j.className}`,children:[e.jsx(I,{className:"h-3 w-3"}),j.label]}),e.jsx(es,{className:`h-4 w-4 text-muted-foreground transition-transform ${L?"rotate-180":""}`})]})]}),L&&e.jsxs("div",{className:"px-4 pb-4 space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Group"}),e.jsx("span",{children:o.group||"—"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Date"}),e.jsx("span",{children:o.date||"—"})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-muted-foreground",children:"Lead"}),e.jsx(_,{name:o.leadName})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Version"}),e.jsxs("span",{className:"text-xs font-mono text-muted-foreground bg-muted px-1.5 py-0.5 rounded",children:["v",A,".0"]})]}),e.jsxs("div",{className:"flex justify-between items-center pt-2 border-t border-border",children:[e.jsx(N,{variant:"outline",size:"sm",className:"text-xs",onClick:()=>c(o.id),children:"Open"}),e.jsx(N,{variant:"ghost",size:"icon",className:"h-7 w-7 text-muted-foreground hover:text-destructive",onClick:Z=>{Z.stopPropagation(),Y.mutate(o.id)},children:e.jsx(xe,{className:"h-3.5 w-3.5"})})]})]})]},o.id)})}),!d&&e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-border bg-muted/50",children:[S("plan")&&e.jsx(D,{label:"Plan",field:"id",current:i,onSort:k}),S("task")&&e.jsx(D,{label:"Task",field:"taskName",current:i,onSort:k}),S("group")&&e.jsx(D,{label:"Group",field:"group",current:i,onSort:k}),S("date")&&e.jsx(D,{label:"Date",field:"date",current:i,onSort:k}),S("lead")&&e.jsx(D,{label:"Lead",field:"leadName",current:i,onSort:k}),S("version")&&e.jsx("th",{className:"text-left py-3 px-5 text-xs font-semibold uppercase tracking-wide text-muted-foreground",children:"Version"}),S("status")&&e.jsx(D,{label:"Status",field:"status",current:i,onSort:k}),e.jsx("th",{className:"py-3 px-5"})]})}),e.jsx("tbody",{children:de.map(o=>{const j=J[o.status]||J.draft,I=j.icon,A=h[o.id]||1;return e.jsxs("tr",{className:"border-b border-border last:border-0 hover:bg-primary/5 cursor-pointer transition-colors",onClick:()=>c(o.id),children:[S("plan")&&e.jsx("td",{className:"py-3.5 px-5",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"p-1.5 rounded-md bg-primary/10",children:e.jsx(T,{className:"w-3.5 h-3.5 text-primary"})}),e.jsxs("span",{className:"text-sm font-medium",children:["ISP-",String(o.id).padStart(4,"0")]})]})}),S("task")&&e.jsxs("td",{className:"py-3.5 px-5",children:[e.jsx("p",{className:"text-sm font-medium truncate max-w-[200px]",children:o.taskName}),e.jsx("p",{className:"text-xs text-muted-foreground",children:o.location})]}),S("group")&&e.jsx("td",{className:"py-3.5 px-5 text-sm text-muted-foreground",children:o.group}),S("date")&&e.jsx("td",{className:"py-3.5 px-5 text-sm text-muted-foreground",children:o.date}),S("lead")&&e.jsx("td",{className:"py-3.5 px-5",children:e.jsx(_,{name:o.leadName})}),S("version")&&e.jsx("td",{className:"py-3.5 px-5",children:e.jsxs("span",{className:"text-xs font-mono text-muted-foreground bg-muted px-1.5 py-0.5 rounded",children:["v",A,".0"]})}),S("status")&&e.jsx("td",{className:"py-3.5 px-5",children:e.jsxs(F,{variant:"outline",className:`gap-1 ${j.className}`,children:[e.jsx(I,{className:"h-3 w-3"}),j.label]})}),e.jsx("td",{className:"py-3.5 px-5",children:e.jsx(N,{variant:"ghost",size:"icon",className:"h-7 w-7 text-muted-foreground hover:text-destructive",onClick:L=>{L.stopPropagation(),Y.mutate(o.id)},children:e.jsx(xe,{className:"h-3.5 w-3.5"})})})]},o.id)})})]})})]}),!u&&q.length>0&&e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-2 px-5 py-3 border-t border-border bg-muted/30 text-xs text-muted-foreground",children:[e.jsxs("span",{children:["Showing ",a?q.length:`${(f-1)*W+1}–${Math.min(f*W,H.length)}`," of ",q.length," plan",q.length!==1?"s":"",t&&` matching "${t}"`]}),e.jsxs("div",{className:"flex items-center gap-2",children:[!a&&R>1&&e.jsxs(e.Fragment,{children:[e.jsx(N,{variant:"outline",size:"sm",className:"h-7 text-xs px-2",disabled:f<=1,onClick:()=>w(o=>o-1),children:"Prev"}),e.jsxs("span",{className:"text-xs tabular-nums",children:[f," / ",R]}),e.jsx(N,{variant:"outline",size:"sm",className:"h-7 text-xs px-2",disabled:f>=R,onClick:()=>w(o=>o+1),children:"Next"})]}),e.jsx(N,{variant:"ghost",size:"sm",className:"h-7 text-xs",onClick:()=>{C(!a),w(1)},children:a?`Show ${W} per page`:"Show all"})]})]})]})}const Ce={q1_specializedTraining:"Specialized Training",q2_chemicals:"Chemicals / Hazardous Materials",q3_impactOthers:"Other Work in Area",q4_falls:"Fall Hazard",q5_barricades:"Barricades Required",q6_loto:"LOTO Required",q7_lifting:"Heavy Lifting",q8_ergonomics:"Ergonomic Concerns",q9_otherConcerns:"Other Safety Concerns",q10_headInjury:"Head Injury Risk",q11_otherPPE:"Additional PPE"};function Es(r){return r>=12?{bg:"bg-red-500",text:"text-white",label:"Extreme",border:"border-red-200 dark:border-red-500/20"}:r>=8?{bg:"bg-orange-500",text:"text-white",label:"High",border:"border-orange-200 dark:border-orange-500/20"}:r>=4?{bg:"bg-amber-400",text:"text-amber-900",label:"Medium",border:"border-amber-200 dark:border-amber-500/20"}:{bg:"bg-primary",text:"text-primary-foreground",label:"Low",border:"border-primary/20"}}function _s(r){return r?new Date(r).toLocaleDateString("en-IE",{day:"numeric",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"}):"—"}function Os({plan:r,onBack:c,onEdit:n}){const l=Object.entries(Ce).filter(([t])=>r[t]==="yes"),d=Object.entries(Ce).filter(([t])=>r[t]==="no"),x=r.hazards.filter(t=>{var s;return(s=r.assessments[t])==null?void 0:s.requiresChecklist}),u=r.hazards.filter(t=>{var s;return(s=r.assessments[t])==null?void 0:s.requiresPtW}),{data:m=[]}=V({queryKey:["/api/audit-logs",{safetyPlanId:r.id}],queryFn:()=>fetch(`/api/audit-logs?safetyPlanId=${r.id}`).then(t=>t.json()),enabled:!!r.id});return e.jsxs("div",{className:"max-w-3xl mx-auto py-6 px-4",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-5",children:[e.jsx(N,{type:"button",variant:"ghost",size:"icon",onClick:c,className:"h-8 w-8 shrink-0",children:e.jsx(rs,{className:"h-4 w-4"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[r.id&&e.jsxs(F,{variant:"outline",className:"text-[10px] font-mono shrink-0",children:["ISP-",String(r.id).padStart(4,"0")]}),e.jsx("h1",{className:"text-lg font-semibold truncate",children:r.taskName})]}),e.jsxs("div",{className:"flex items-center gap-2 mt-0.5",children:[e.jsx(F,{variant:r.status==="approved"?"default":"secondary",className:"text-[10px]",children:r.status}),e.jsx("span",{className:"text-xs text-muted-foreground",children:r.date})]})]}),n&&e.jsxs(N,{type:"button",variant:"outline",size:"sm",onClick:n,className:"shrink-0 gap-1.5",children:[e.jsx(ue,{className:"h-3.5 w-3.5"})," Edit"]})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-x-4 gap-y-1 text-sm text-muted-foreground bg-muted/50 rounded-lg px-4 py-2.5 mb-5",children:[e.jsxs("span",{children:[e.jsx("strong",{className:"text-foreground",children:"Shift:"})," ",r.shift]}),e.jsxs("span",{children:[e.jsx("strong",{className:"text-foreground",children:"Location:"})," ",r.location]}),e.jsxs("span",{children:[e.jsx("strong",{className:"text-foreground",children:"Machine:"})," ",r.machineNumber]}),e.jsxs("span",{children:[e.jsx("strong",{className:"text-foreground",children:"Group:"})," ",r.group]}),e.jsxs("span",{children:[e.jsx("strong",{className:"text-foreground",children:"System:"})," ",r.system]})]}),l.length>0?e.jsxs(z,{className:"p-4 mb-4 border-amber-200 dark:border-amber-500/20 bg-amber-50/50 dark:bg-amber-500/5",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(Oe,{className:"h-4 w-4 text-amber-600"}),e.jsxs("p",{className:"text-sm font-semibold text-amber-800 dark:text-amber-400",children:[l.length," Safety Concern",l.length!==1?"s":""," Flagged"]})]}),e.jsx("div",{className:"flex flex-wrap gap-1.5",children:l.map(([,t])=>e.jsx("span",{className:"px-2.5 py-1 rounded-md bg-amber-100 dark:bg-amber-500/20 text-amber-800 dark:text-amber-300 text-xs font-medium border border-amber-200 dark:border-amber-500/20",children:t},t))}),d.length>0&&e.jsxs("div",{className:"flex items-center gap-1.5 mt-3 pt-2 border-t border-amber-200/50 dark:border-amber-500/10",children:[e.jsx(se,{className:"h-3 w-3 text-primary"}),e.jsxs("p",{className:"text-[11px] text-muted-foreground",children:[d.length," item",d.length!==1?"s":""," cleared"]})]})]}):e.jsx(z,{className:"p-4 mb-4 border-primary/20 bg-primary/5",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(se,{className:"h-4 w-4 text-primary"}),e.jsx("p",{className:"text-sm font-semibold text-primary",children:"All Safety Checks Cleared"})]})}),e.jsxs("div",{className:"mb-5",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(U,{className:"h-4 w-4 text-primary"}),e.jsxs("p",{className:"text-sm font-semibold",children:["Hazards (",r.hazards.length,")"]})]}),r.hazards.length===0?e.jsx("p",{className:"text-sm text-muted-foreground px-1",children:"No hazards identified."}):e.jsx("div",{className:"space-y-3",children:r.hazards.map(t=>{const s=r.assessments[t],i=s?s.severity*s.likelihood:0,p=Es(i),a=G(t);return e.jsxs(z,{className:b("p-4",p.border),children:[e.jsxs("div",{className:"flex items-start justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2.5",children:[e.jsx("span",{className:b("h-7 min-w-[28px] px-1.5 flex items-center justify-center rounded-md text-[11px] font-bold",p.bg,p.text),children:i}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-semibold",children:t}),a&&e.jsxs("p",{className:"text-[11px] text-muted-foreground/60",children:["e.g. ",a.example]})]})]}),e.jsxs("div",{className:"flex items-center gap-2 shrink-0",children:[e.jsx("span",{className:b("text-[10px] font-semibold uppercase px-2 py-0.5 rounded",p.bg,p.text),children:p.label}),s&&e.jsxs("span",{className:"text-[10px] text-muted-foreground",children:["S:",s.severity," × L:",s.likelihood]})]})]}),((s==null?void 0:s.requiresChecklist)||(s==null?void 0:s.requiresPtW)||(a==null?void 0:a.training))&&e.jsxs("div",{className:"flex flex-wrap gap-1.5 mb-2.5",children:[(s==null?void 0:s.requiresChecklist)&&e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-0.5 rounded bg-blue-500/10 text-blue-600 text-[10px] font-medium border border-blue-500/20",children:[e.jsx(B,{className:"h-3 w-3"})," ",s.checklistType||"Checklist Required"]}),(s==null?void 0:s.requiresPtW)&&e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-0.5 rounded bg-amber-500/10 text-amber-600 text-[10px] font-medium border border-amber-500/20",children:[e.jsx(T,{className:"h-3 w-3"})," ",s.permitType||"PtW Required"]}),(a==null?void 0:a.training)&&e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-0.5 rounded bg-muted text-muted-foreground text-[10px] font-medium",children:[e.jsx(ee,{className:"h-3 w-3"})," ",a.training]})]}),s!=null&&s.mitigation?e.jsxs("div",{className:"rounded-md bg-primary/5 border border-primary/10 px-3 py-2.5",children:[e.jsx("p",{className:"text-[10px] font-semibold uppercase tracking-wider text-primary mb-1",children:"Mitigation Plan"}),e.jsx("p",{className:"text-sm text-foreground leading-relaxed",children:s.mitigation})]}):e.jsx("p",{className:"text-xs text-destructive/70 italic",children:"No mitigation plan provided"})]},t)})})]}),(x.length>0||u.length>0)&&e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3 mb-5",children:[x.length>0&&e.jsxs(z,{className:"p-3 border-blue-200 dark:border-blue-500/20 bg-blue-50/50 dark:bg-blue-500/5",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(B,{className:"h-4 w-4 text-blue-600"}),e.jsx("p",{className:"text-xs font-semibold text-blue-800 dark:text-blue-400",children:"Required Checklists"})]}),e.jsx("div",{className:"space-y-1",children:x.map(t=>{var s;return e.jsxs("p",{className:"text-[11px] text-blue-700 dark:text-blue-400/80",children:[(s=r.assessments[t])==null?void 0:s.checklistType," — ",t]},t)})})]}),u.length>0&&e.jsxs(z,{className:"p-3 border-amber-200 dark:border-amber-500/20 bg-amber-50/50 dark:bg-amber-500/5",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(T,{className:"h-4 w-4 text-amber-600"}),e.jsx("p",{className:"text-xs font-semibold text-amber-800 dark:text-amber-400",children:"Linked Permit to Work"})]}),e.jsx("div",{className:"space-y-1",children:u.map(t=>{var s;return e.jsxs("p",{className:"text-[11px] text-amber-700 dark:text-amber-400/80",children:[(s=r.assessments[t])==null?void 0:s.permitType," — ",t]},t)})})]})]}),e.jsxs(z,{className:"p-4 mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(Me,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("p",{className:"text-sm font-semibold",children:"Sign Off"})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2.5",children:[e.jsx(_,{name:r.leadName}),e.jsxs("div",{children:[e.jsx("p",{className:"text-[10px] uppercase tracking-wider text-muted-foreground",children:"Lead"}),e.jsx("p",{className:"text-sm font-medium",children:r.leadName||"—"})]})]}),e.jsxs("div",{className:"flex items-center gap-2.5",children:[e.jsx(_,{name:r.approverName||""}),e.jsxs("div",{children:[e.jsx("p",{className:"text-[10px] uppercase tracking-wider text-muted-foreground",children:"Manager"}),e.jsx("p",{className:"text-sm font-medium",children:r.approverName||"—"})]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-[10px] uppercase tracking-wider text-muted-foreground mb-1.5",children:"Team"}),r.engineers.length>0?e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("div",{className:"flex -space-x-1.5",children:r.engineers.slice(0,4).map(t=>e.jsx(_,{name:t,className:"h-6 w-6 text-[9px] ring-2 ring-background"},t))}),r.engineers.length>4&&e.jsxs("span",{className:"text-[10px] text-muted-foreground",children:["+",r.engineers.length-4]})]}):e.jsx("p",{className:"text-sm text-muted-foreground",children:"—"})]})]}),r.comments&&e.jsxs("p",{className:"text-sm text-muted-foreground mt-3 pt-3 border-t border-border italic",children:['"',r.comments,'"']})]}),r.id&&e.jsxs(z,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(as,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("p",{className:"text-sm font-semibold",children:"Version History"}),e.jsxs(F,{variant:"secondary",className:"ml-auto text-[10px]",children:["v",Math.max(1,m.filter(t=>t.action==="edited").length+1),".0"]})]}),m.length===0?e.jsx("p",{className:"text-sm text-muted-foreground",children:"No audit trail available."}):e.jsxs("div",{className:"relative pl-5 space-y-3",children:[e.jsx("div",{className:"absolute left-[7px] top-1 bottom-1 w-px bg-border"}),m.map((t,s)=>{const i=s===0,p={created:"bg-primary",edited:"bg-amber-500",approved:"bg-blue-500",rejected:"bg-red-500"};return e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:b("absolute -left-5 top-1.5 w-2.5 h-2.5 rounded-full border-2 border-background",p[t.action]||"bg-muted-foreground")}),e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm font-medium capitalize",children:t.action}),i&&e.jsx(F,{variant:"outline",className:"text-[10px] px-1.5 py-0",children:"Latest"})]}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-0.5",children:["by ",t.performedBy,t.previousStatus&&t.newStatus&&t.previousStatus!==t.newStatus&&e.jsxs("span",{children:[" · ",t.previousStatus," → ",t.newStatus]})]}),t.comments&&e.jsxs("p",{className:"text-xs text-muted-foreground mt-1 italic",children:['"',t.comments,'"']})]}),e.jsx("span",{className:"text-[10px] text-muted-foreground whitespace-nowrap shrink-0",children:_s(t.createdAt)})]})]},t.id)})]})]})]})}const qe=["","Task Details","Safety Questions","Hazard Identification","Sign Off"],Q={group:"",taskName:"",date:"",location:"",shift:"",machineNumber:"",region:"Europe - Ireland",system:"Others",canSocialDistance:"yes",q1_specializedTraining:"no",q2_chemicals:"no",q3_impactOthers:"no",q4_falls:"no",q5_barricades:"no",q6_loto:"no",q7_lifting:"no",q8_ergonomics:"no",q9_otherConcerns:"no",q10_headInjury:"no",q11_otherPPE:"no",hazards:[],assessments:{},leadName:"",approverName:"",engineers:[],comments:"",status:"pending"};function Gs(){const[r,c]=g.useState("list"),[n,l]=g.useState(null),[d,x]=g.useState(1),[u,m]=g.useState([]),[t,s]=g.useState(Q),[i,p]=g.useState(!1),a=He(),{toast:C}=ns(),{data:f}=V({queryKey:["/api/user-preferences","default"]}),{data:w=[]}=V({queryKey:["/api/safety-plans"]}),{data:P=[]}=V({queryKey:["/api/permits"]}),v={machines:Array.from(new Set(w.map(h=>h.machineNumber).filter(Boolean))),locations:Array.from(new Set(w.map(h=>h.location).filter(Boolean))),shifts:Array.from(new Set(["Day","Night","Swing",...w.map(h=>h.shift).filter(Boolean)]))},y=Ie({mutationFn:h=>De("POST","/api/safety-plans",h),onSuccess:()=>{a.invalidateQueries({queryKey:["/api/safety-plans"]}),c("list"),x(1),m([]),s(Q),C({title:"Safety Plan submitted successfully."})}}),O=()=>{const h=new Date().toISOString().split("T")[0];s({...Q,system:(f==null?void 0:f.system)||"Others",group:(f==null?void 0:f.group)||"Europe",region:(f==null?void 0:f.site)||"Europe - Ireland",date:h,canSocialDistance:"yes"}),x(1),m([]),c("form")},X=()=>{c("list"),x(1),m([]),s(Q)},le=h=>{s(k=>({...k,...h})),m([1]),x(2)},Y=()=>{m(h=>Array.from(new Set([...h,d]))),x(h=>Math.min(h+1,4))},q=(h,k)=>{s(R=>({...R,[h]:k}))},H=h=>{s({...Q,...h}),m([1,2,3]),x(1),c("form")};return r==="list"?e.jsx("div",{className:"p-4 sm:p-6",children:e.jsx(zs,{onNew:O,onEdit:h=>{const k=w.find(R=>R.id===h);k&&(l(k),c("view"))}})}):r==="view"&&n?e.jsx("div",{className:"p-4 sm:p-6",children:e.jsx(Os,{plan:n,onBack:()=>{l(null),c("list")},onEdit:n.status!=="approved"?()=>H(n):void 0})}):e.jsxs("div",{className:"p-4 sm:p-6",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:min-h-[540px] max-w-6xl mx-auto border border-border rounded-lg overflow-hidden bg-card",children:[e.jsx(hs,{currentStep:d,completedSteps:u,onStepClick:x,prefilled:{system:t.system,group:t.group,region:t.region,date:t.date},taskSummary:{taskName:t.taskName,shift:t.shift,location:t.location,machineNumber:t.machineNumber},onEditDetails:()=>x(1),onExit:X}),e.jsxs("div",{className:"flex-1 flex flex-col",children:[e.jsxs("div",{className:"hidden md:flex items-center justify-between px-6 py-3 border-b border-border bg-muted/30",children:[e.jsx("h2",{className:"text-base font-semibold",children:qe[d]}),e.jsx(N,{type:"button",variant:"outline",size:"sm",onClick:X,children:"Exit Record"})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4 sm:p-6",children:e.jsxs("div",{className:"max-w-3xl mx-auto",children:[d===1&&e.jsx(fs,{onSubmit:le,defaultValues:{system:t.system,group:t.group,region:t.region,date:t.date,canSocialDistance:t.canSocialDistance},knownValues:v}),d===2&&e.jsx(js,{values:t,onChange:(h,k)=>q(h,k)}),d===3&&e.jsx(qs,{hazards:t.hazards,assessments:t.assessments,onHazardsChange:(h,k)=>s(R=>({...R,hazards:h,assessments:k}))}),d===4&&e.jsx(Ts,{leadName:t.leadName,approverName:t.approverName??"",engineers:t.engineers,comments:t.comments??"",linkedPermitId:t.linkedPermitId,permits:P,onChange:q}),d>1&&e.jsxs("div",{className:"flex items-center justify-between mt-6 pt-4 border-t border-border",children:[e.jsx(N,{type:"button",variant:"outline",onClick:()=>x(h=>h-1),children:"← Back"}),e.jsxs("div",{className:"flex items-center gap-2",children:[d===4&&e.jsxs(e.Fragment,{children:[e.jsxs(N,{type:"button",variant:"outline",onClick:()=>p(!0),className:"gap-1.5",children:[e.jsx(is,{className:"h-3.5 w-3.5"})," Preview"]}),e.jsx(N,{type:"button",onClick:()=>y.mutate(t),disabled:y.isPending,children:y.isPending?"Saving...":"Complete & Submit"})]}),d<4&&e.jsxs(N,{type:"button",onClick:Y,className:"gap-2",children:["Next: ",qe[d+1]," →"]})]})]})]})})]})]}),e.jsx(Ls,{open:i,onOpenChange:p,data:t})]})}export{Gs as default};
